<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerr - Multi-Particle Trajectory Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0a0a0a;
            color: #fff;
            overflow: hidden;
        }
        
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            max-width: 300px;
        }
        
        h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        
        .button {
            background: #2980b9;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 2px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .button:hover {
            background: #3498db;
        }
        
        .button.active {
            background: #27ae60;
        }
        
        input[type="range"] {
            width: 200px;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
        }
        
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #e74c3c;
            display: none;
        }
        
        .particle-legend {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .particle-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            cursor: pointer;
        }
        
        .particle-item:hover {
            opacity: 0.8;
        }
        
        .particle-item.disabled {
            opacity: 0.3;
        }
        
        .color-box {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
        }
        
        .stats {
            font-size: 12px;
            color: #999;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div id="loading">Loading trajectories...</div>
    <div id="error"></div>
    
    <div class="controls">
        <h3>Controls</h3>
        <div>
            <button class="button" id="playPause">Play</button>
            <button class="button" id="reset">Reset</button>
        </div>
        <div style="margin-top: 10px;">
            <label>Speed: <input type="range" id="speed" min="0" max="10" value="3" step="0.1"></label>
        </div>
        <div style="margin-top: 10px;">
            <label>Zoom: <input type="range" id="zoom" min="0.1" max="10" value="1" step="0.1"></label>
        </div>
        <div style="margin-top: 10px;">
            <button class="button" id="toggleTrail">Show Trail</button>
            <button class="button" id="toggleGrid">Show Grid</button>
        </div>
    </div>
    
    <div class="info">
        <h3>Kerr</h3>
        <div>Black Hole Mass: 99450000000000.0 kg</div>
        <div>Step: <span id="stepInfo">0 / 0</span></div>
        <div>Time: <span id="timeInfo">0.00e+00</span> s</div>
        
        <div class="particle-legend" id="particleLegend">
            <h4>Particles (click to toggle)</h4>
        </div>
        
        <div class="stats" id="stats"></div>
    </div>

    <script>
        // Multi-particle trajectory data will be injected here
        const PARTICLE_DATA = {"electron": {"theory": {"positions": [[8.9113923229424e-12, 0.0], [8.911392323365677e-12, -2.601098832281963e-05], [8.911392324809054e-12, -5.462307547212712e-05], [8.911392327579871e-12, -8.609637132186868e-05], [8.911392332059326e-12, -0.00012071699672907979], [8.911392338718907e-12, -0.00015879968463046993], [8.911392348140385e-12, -0.00020069064124803203], [8.9113923610401e-12, -0.00024677069341435653], [8.911392378298452e-12, -0.00029745875062932086], [8.911392400995724e-12, -0.0003532156133208902], [8.911392430455555e-12, -0.00041454816192990095], [8.9113924682977e-12, -0.0004820139649005039], [8.911392516502013e-12, -0.0005562263474658644], [8.911392577486086e-12, -0.0006378599673073521], [8.911392654199353e-12, -0.0007276569477728349], [8.9113927502372e-12, -0.0008264336244076737], [8.911392869979264e-12, -0.0009350879661265921], [8.911393018757065e-12, -0.0010546077384863731], [8.91139320305709e-12, -0.0011860794832639434], [8.911393430766902e-12, -0.0013306983959630108], [8.911393711473229e-12, -0.0014897791910322698], [8.911394056823091e-12, -0.0016647680535532012], [8.91139448096115e-12, -0.0018572557860269073], [8.911395001059399e-12, -0.002068992269746523], [8.911395637958607e-12, -0.0023019023721826044], [8.911396416945006e-12, -0.002558103444941254], [8.911397291835117e-12, -0.0028182130687183777], [8.911398251380795e-12, -0.003078322639896098], [8.911399295582043e-12, -0.0033384321536197173], [8.911400424438872e-12, -0.003598541605034542], [8.911401637951288e-12, -0.0038586509892858827], [8.911402936119302e-12, -0.004118760301519057], [8.911404318942923e-12, -0.004378869536879386], [8.911405786422162e-12, -0.004638978690512198], [8.911407338557027e-12, -0.004899087757562827], [8.911408975347533e-12, -0.005159196733176613], [8.91141069679369e-12, -0.005419305612498903], [8.911412502895513e-12, -0.005679414390675054], [8.911414393653011e-12, -0.005939523062850427], [8.911416369066201e-12, -0.006199631624170393], [8.911418429135099e-12, -0.006459740069780331], [8.911420573859715e-12, -0.00671984839482563], [8.911422803240068e-12, -0.0069799565944516865], [8.911425117276175e-12, -0.007240064663803908], [8.911427515968051e-12, -0.007500172598027711], [8.911429999315715e-12, -0.007760280392268523], [8.911432567319184e-12, -0.00802038804167178], [8.911435219978478e-12, -0.008280495541382934], [8.911437957293616e-12, -0.008540602886547443], [8.911440779264619e-12, -0.008800710072310779], [8.911443685891507e-12, -0.009060817093818428], [8.911446677174301e-12, -0.009320923946215885], [8.911449753113023e-12, -0.00958103062464866], [8.911452913707698e-12, -0.009841137124262277], [8.911456158958347e-12, -0.010101243440202272], [8.911459488864994e-12, -0.010361349567614194], [8.911462903427666e-12, -0.01062145550164361], [8.911466402646386e-12, -0.0108815612374361], [8.911469986521181e-12, -0.01114166677013726], [8.911473655052076e-12, -0.011401772094892697], [8.911477408239098e-12, -0.01166187720684804], [8.911481246082274e-12, -0.011921982101148929], [8.911485168581634e-12, -0.012182086772941025], [8.911489175737208e-12, -0.012442191217370006], [8.91149326754902e-12, -0.012702295429581562], [8.911497444017106e-12, -0.012962399404721405], [8.911501705141495e-12, -0.013222503137935266], [8.911506050922218e-12, -0.013482606624368891], [8.911510481359307e-12, -0.013742709859168048], [8.911514996452793e-12, -0.014002812837478522], [8.911519596202712e-12, -0.014262915554446118], [8.911524280609097e-12, -0.014523018005216663], [8.91152904967198e-12, -0.014783120184936], [8.9115339033914e-12, -0.015043222088749999], [8.91153884176739e-12, -0.015303323711804545], [8.911543864799989e-12, -0.015563425049245547], [8.91154897248923e-12, -0.015823526096218937], [8.911554164835155e-12, -0.016083626847870666], [8.9115594418378e-12, -0.016343727299346713], [8.911564803497203e-12, -0.01660382744579307], [8.911570249813403e-12, -0.016863927282355765], [8.911575780786442e-12, -0.01712402680418084], [8.911581396416361e-12, -0.017384126006414365], [8.911587096703199e-12, -0.017644224884202434], [8.911592881647e-12, -0.017904323432691164], [8.911598751247805e-12, -0.0181644216470267], [8.91160470550566e-12, -0.01842451952235521], [8.911610744420604e-12, -0.01868461705382289], [8.911616867992687e-12, -0.01894471423657596], [8.91162307622195e-12, -0.019204811065760673], [8.91162936910844e-12, -0.019464907536523298], [8.911635746652204e-12, -0.019725003644010138], [8.911642208853288e-12, -0.019985099383367524], [8.911648755711739e-12, -0.020245194749741815], [8.911655387227608e-12, -0.020505289738279395], [8.91166210340094e-12, -0.02076538434412668], [8.911668904231788e-12, -0.021025478562430117], [8.911675789720203e-12, -0.021285572388336175], [8.911682759866231e-12, -0.021545665816991362], [8.911689814669925e-12, -0.021805758843542213]], "velocities": [], "times": [0.0, 2.8625933893146332e-24, 6.011446117493653e-24, 9.47518411832275e-24, 1.3285295918916342e-23, 1.7476418899030482e-23, 2.2086654176299737e-23, 2.7157912979987806e-23, 3.273629766209987e-23, 3.887252080958808e-23, 4.5622366267753364e-23, 5.304719626595478e-23, 6.12145092558459e-23, 7.019855353337613e-23, 8.008100222291313e-23, 9.095169575967196e-23, 1.0290945862024538e-22, 1.1606299772599811e-22, 1.3053189068654686e-22, 1.464476728672499e-22, 1.6395503316299295e-22, 1.832131293487489e-22, 2.0439703496438636e-22, 2.2769933088688083e-22, 2.5333185605830867e-22, 2.8152763328472093e-22, 3.1015356417425133e-22, 3.387794944548483e-22, 3.674054240703099e-22, 3.960313529644342e-22, 4.246572810810193e-22, 4.532832083638634e-22, 4.819091347567649e-22, 5.105350602035218e-22, 5.391609846479325e-22, 5.677869080337955e-22, 5.964128303049093e-22, 6.250387514050724e-22, 6.536646712780834e-22, 6.82290589867741e-22, 7.10916507117844e-22, 7.395424229721912e-22, 7.681683373745816e-22, 7.9679425026881415e-22, 8.2542016159868805e-22, 8.540460713080025e-22, 8.82671979340557e-22, 9.112978856401507e-22, 9.399237901505833e-22, 9.685496928156546e-22, 9.971755935791642e-22, 1.0258014923849122e-21, 1.0544273891766982e-21, 1.0830532838983227e-21, 1.1116791764935858e-21, 1.1403050669062881e-21, 1.1689309550802299e-21, 1.1975568409592121e-21, 1.2261827244870352e-21, 1.2548086056075006e-21, 1.2834344842644092e-21, 1.3120603604015624e-21, 1.3406862339627615e-21, 1.369312104891808e-21, 1.3979379731325041e-21, 1.4265638386286514e-21, 1.455189701324052e-21, 1.4838155611625084e-21, 1.512441418087823e-21, 1.5410672720437981e-21, 1.5696931229742372e-21, 1.5983189708229427e-21, 1.626944815533718e-21, 1.6555706570503665e-21, 1.684196495316692e-21, 1.7128223302764983e-21, 1.7414481618735894e-21, 1.7700739900517694e-21, 1.798699814754843e-21, 1.8273256359266148e-21, 1.8559514535108894e-21, 1.884577267451472e-21, 1.9132030776921683e-21, 1.9418288841767835e-21, 1.970454686849124e-21, 1.999080485652995e-21, 2.0277062805322037e-21, 2.056332071430556e-21, 2.0849578582918587e-21, 2.113583641059919e-21, 2.142209419678544e-21, 2.1708351940915422e-21, 2.1994609642427202e-21, 2.2280867300758873e-21, 2.2567124915348507e-21, 2.2853382485634195e-21, 2.3139640011054032e-21, 2.34258974910461e-21, 2.37121549250485e-21, 2.399841231249933e-21], "losses": []}}, "neutrino": {"theory": {"positions": [[8.9113923229424e-12, -0.028867513459481287], [8.910701549753889e-12, 3.351120368080596e-05], [8.909941707916033e-12, 7.037952923370064e-05], [8.909105892386884e-12, 0.00011094195093831131], [8.908186508003925e-12, 0.0001555694061304537], [8.907175200552827e-12, 0.00020467024748493525], [8.90606278096016e-12, 0.000258694052346644], [8.904839141926029e-12, 0.0003181358273184781], [8.90349316624504e-12, 0.0003835406506684692], [8.90201262598972e-12, 0.00045550880002193854], [8.900384071649086e-12, 0.0005347014183374609], [8.898592710225705e-12, 0.0006218467774210349], [8.89662227119658e-12, 0.0007177472053204151], [8.89445485913578e-12, 0.0008232867519895041], [8.892070791678982e-12, 0.0009394396767724446], [8.889448421381161e-12, 0.0010672798517076545], [8.88656393987738e-12, 0.0012079911866058712], [8.883391162602207e-12, 0.0013628791955659682], [8.8799012921542e-12, 0.0015333838403593114], [8.876062658207257e-12, 0.001721093804298598], [8.871840431668928e-12, 0.001927762371243646], [8.86719631056577e-12, 0.0021553251088063012], [8.862088174895945e-12, 0.0024059195832299082], [8.85646970742831e-12, 0.002681907366599887], [8.850289977143363e-12, 0.0029858986359202495], [8.843492981703546e-12, 0.003320779709300514], [8.836593051590927e-12, 0.0036612967142388817], [8.82969388897188e-12, 0.004002345880983945], [8.822795495444246e-12, 0.004343928398542201], [8.81589787261005e-12, 0.0046860454592853925], [8.809001022075521e-12, 0.005028698258961731], [8.802104945451096e-12, 0.005371887996707183], [8.795209644351446e-12, 0.00571561587505678], [8.788315120395477e-12, 0.006059883099955985], [8.781421375206346e-12, 0.006404690880772089], [8.77452841041148e-12, 0.0067500404303056614], [8.76763622764258e-12, 0.007095932964802033], [8.760744828535641e-12, 0.007442369703962828], [8.753854214730965e-12, 0.007789351870957542], [8.746964387873167e-12, 0.008136880692435152], [8.74007534961119e-12, 0.008484957398535782], [8.733187101598332e-12, 0.008833583222902406], [8.72629964549224e-12, 0.009182759402692593], [8.719412982954936e-12, 0.009532487178590303], [8.712527115652821e-12, 0.009882767794817721], [8.705642045256699e-12, 0.010233602499147135], [8.698757773441781e-12, 0.010584992542912862], [8.69187430188771e-12, 0.01093693918102322], [8.684991632278554e-12, 0.011289443671972542], [8.678109766302846e-12, 0.011642507277853226], [8.671228705653578e-12, 0.011996131264367852], [8.664348452028221e-12, 0.012350316900841323], [8.65746900712874e-12, 0.012705065460233063], [8.650590372661607e-12, 0.013060378219149259], [8.643712550337812e-12, 0.013416256457855144], [8.636835541872882e-12, 0.013772701460287334], [8.62995934898689e-12, 0.014129714514066206], [8.623083973404476e-12, 0.014487296910508318], [8.616209416854848e-12, 0.01484544994463889], [8.609335681071811e-12, 0.015204174915204316], [8.602462767793773e-12, 0.015563473124684733], [8.595590678763756e-12, 0.01592334587930663], [8.58871941572942e-12, 0.016283794489055516], [8.58184898044307e-12, 0.016644820267688622], [8.574979374661672e-12, 0.017006424532747658], [8.568110600146867e-12, 0.017368608605571614], [8.56124265866499e-12, 0.01773137381130962], [8.554375551987075e-12, 0.01809472147893383], [8.547509281888876e-12, 0.018458652941252394], [8.540643850150882e-12, 0.018823169534922427], [8.53377925855833e-12, 0.019188272600463078], [8.526915508901216e-12, 0.019553963482268615], [8.520052602974318e-12, 0.01992024352862157], [8.513190542577204e-12, 0.020287114091705933], [8.506329329514247e-12, 0.020654576527620396], [8.499468965594644e-12, 0.021022632196391642], [8.49260945263243e-12, 0.0213912824619877], [8.485750792446483e-12, 0.02176052869233132], [8.478892986860556e-12, 0.02213037225931343], [8.47203603770328e-12, 0.022500814538806636], [8.465179946808184e-12, 0.022871856910678747], [8.458324716013706e-12, 0.02324350075880639], [8.45147034716321e-12, 0.023615747471088643], [8.444616842105005e-12, 0.02398859843946075], [8.437764202692356e-12, 0.024362055059907853], [8.430912430783498e-12, 0.024736118732478815], [8.424061528241656e-12, 0.025110790861300053], [8.41721149693506e-12, 0.025486072854589457], [8.410362338736953e-12, 0.025861966124670347], [8.403514055525619e-12, 0.026238472087985486], [8.396666649184385e-12, 0.02661559216511114], [8.38982012160165e-12, 0.026993327780771202], [8.382974474670887e-12, 0.027371680363851354], [8.376129710290671e-12, 0.0277506513474133], [8.369285830364686e-12, 0.028130242168709036], [8.362442836801747e-12, 0.028510454269195188], [8.355600731515813e-12, 0.028891289094547395], [8.348759516426001e-12, 0.029272748094674745], [8.341919193456606e-12, 0.029654832723734283], [8.335079764537113e-12, 0.030037544440145544]], "velocities": [], "times": [0.0, 2.972543560342106e-24, 6.242394713001658e-24, 9.839295409282669e-24, 1.3795964150081389e-23, 1.8148394136650666e-23, 2.2936181341013714e-23, 2.820288551010327e-23, 3.3996427423803143e-23, 4.0369526064782654e-23, 4.738017973071752e-23, 5.509219553094597e-23, 6.357577216401236e-23, 7.290814137458859e-23, 8.317427404317968e-23, 9.446765747568435e-23, 1.068911511388883e-22, 1.2055792883972565e-22, 1.3559251617900432e-22, 1.5213193303368738e-22, 1.703269518464264e-22, 1.9034348363898346e-22, 2.1236410493124887e-22, 2.365897401555276e-22, 2.632415157246915e-22, 2.9256280366344973e-22, 3.223360701400064e-22, 3.521140336444983e-22, 3.8189670248154548e-22, 4.116840849766298e-22, 4.414761894761615e-22, 4.712730243475456e-22, 5.010745979792492e-22, 5.308809187808677e-22, 5.606919951831929e-22, 5.905078356382804e-22, 6.203284486195172e-22, 6.501538426216898e-22, 6.799840261610533e-22, 7.098190077753985e-22, 7.396587960241227e-22, 7.695033994882974e-22, 7.993528267707378e-22, 8.292070864960736e-22, 8.590661873108173e-22, 8.889301378834358e-22, 9.1879894690442e-22, 9.486726230863559e-22, 9.785511751639954e-22, 1.008434611894328e-21, 1.0383229420566513e-21, 1.0682161744526443e-21, 1.0981143179064382e-21, 1.1280173812646893e-21, 1.1579253733966516e-21, 1.1878383031942499e-21, 1.2177561795721522e-21, 1.2476790114678443e-21, 1.2776068078417026e-21, 1.3075395776770686e-21, 1.3374773299803235e-21, 1.3674200737809615e-21, 1.3973678181316664e-21, 1.4273205721083857e-21, 1.4572783448104062e-21, 1.48724114536043e-21, 1.51720898290465e-21, 1.547181866612827e-21, 1.5771598056783658e-21, 1.607142809318392e-21, 1.6371308867738301e-21, 1.6671240473094797e-21, 1.697122300214094e-21, 1.7271256548004586e-21, 1.7571341204054678e-21, 1.7871477063902054e-21, 1.8171664221400233e-21, 1.8471902770646194e-21, 1.87721928059812e-21, 1.9072534421991564e-21, 1.9372927713509473e-21, 1.967337277561379e-21, 1.997386970363086e-21, 2.027441859313532e-21, 2.0575019539950914e-21, 2.0875672640151314e-21, 2.1176377990060945e-21, 2.1477135686255796e-21, 2.1777945825564266e-21, 2.2078808505067972e-21, 2.2379723822102607e-21, 2.2680691874258757e-21, 2.2981712759382753e-21, 2.328278657557751e-21, 2.3583913421203382e-21, 2.3885093394878996e-21, 2.4186326595482127e-21, 2.4487613122150526e-21, 2.4788953074282815e-21, 2.5090346551539323e-21], "losses": []}}, "photon": {"theory": {"positions": [[8.9113923229424e-12, 0.0], [8.912051555952846e-12, 4.2025879863671605e-05], [8.91277672589755e-12, 8.82471671446909e-05], [8.91357442932932e-12, 0.00013908189662072075], [8.914451923055533e-12, 0.00019498959094123682], [8.91541719028904e-12, 0.0002564753433511064], [8.916479013440396e-12, 0.0003240942948837256], [8.91764705422098e-12, 0.00039845654259536517], [8.918931941794705e-12, 0.000480232518473394], [8.920345369791134e-12, 0.0005701588818955099], [8.921900203075764e-12, 0.0006690449719384107], [8.923610595264768e-12, 0.0007777798694202784], [8.925492118072637e-12, 0.0008973401222926716], [8.927561903692891e-12, 0.001028798191845587], [8.929838801535461e-12, 0.001173331681115027], [8.932343550780934e-12, 0.001332233410831967], [8.935098970362818e-12, 0.0015069224121546537], [8.938130168156191e-12, 0.0016989559091912625], [8.941464771336042e-12, 0.0019100423678302617], [8.945133180073733e-12, 0.0021420556905037153], [8.949168846967086e-12, 0.0023970506390294933], [8.953608584851694e-12, 0.002677279569382828], [8.958492905920529e-12, 0.0029852105628538268], [8.963866395389452e-12, 0.00332354703721071], [8.969778123291002e-12, 0.003695248918790219], [8.97628209836232e-12, 0.00410355545137198], [8.982886447205432e-12, 0.004517486187160943], [8.989491951746881e-12, 0.004930808661150966], [8.996098609720367e-12, 0.005343524107122676], [9.002706418865023e-12, 0.005755633755831927], [9.009315376925406e-12, 0.0061671388350179055], [9.015925481651485e-12, 0.0065780405694112224], [9.022536730798617e-12, 0.006988340180741983], [9.029149122127542e-12, 0.0073980388877478345], [9.035762653404367e-12, 0.007807137906181996], [9.042377322400546e-12, 0.008215638448821267], [9.048993126892874e-12, 0.00862354172547401], [9.05561006466346e-12, 0.009030848942988121], [9.062228133499732e-12, 0.009437561305258975], [9.0688473311944e-12, 0.009843680013237353], [9.075467655545464e-12, 0.01024920626493734], [9.082089104356182e-12, 0.01065414125544422], [9.088711675435068e-12, 0.011058486176922334], [9.09533536659587e-12, 0.011462242218622921], [9.10196017565756e-12, 0.01186541056689195], [9.108586100444321e-12, 0.012267992405177917], [9.115213138785529e-12, 0.012669988914039632], [9.121841288515742e-12, 0.013071401271153976], [9.128470547474688e-12, 0.01347223065132365], [9.135100913507242e-12, 0.013872478226484892], [9.141732384463425e-12, 0.014272145165715186], [9.148364958198384e-12, 0.014671232635240939], [9.154998632572376e-12, 0.015069741798445141], [9.161633405450757e-12, 0.015467673815875015], [9.168269274703967e-12, 0.01586502984524963], [9.17490623820752e-12, 0.016261811041467514], [9.181544293841987e-12, 0.016658018556614227], [9.18818343949298e-12, 0.01705365353996993], [9.194823673051147e-12, 0.017448717138016913], [9.201464992412153e-12, 0.01784321049444714], [9.208107395476662e-12, 0.01823713475016974], [9.214750880150332e-12, 0.018630491043318487], [9.221395444343798e-12, 0.019023280509259267], [9.228041085972658e-12, 0.019415504280597524], [9.234687802957463e-12, 0.019807163487185687], [9.241335593223698e-12, 0.02019825925613056], [9.247984454701774e-12, 0.020588792711800728], [9.254634385327013e-12, 0.0209787649758339], [9.261285383039635e-12, 0.021368177167144276], [9.267937445784742e-12, 0.021757030401929858], [9.274590571512313e-12, 0.022145325793679765], [9.28124475817718e-12, 0.02253306445318152], [9.287900003739025e-12, 0.02292024748852831], [9.29455630616236e-12, 0.02330687600512625], [9.301213663416516e-12, 0.023692951105701604], [9.307872073475637e-12, 0.024078473890307994], [9.314531534318654e-12, 0.02446344545633359], [9.321192043929281e-12, 0.02484786689850829], [9.327853600296003e-12, 0.02523173930891086], [9.334516201412058e-12, 0.025615063776976095], [9.34117984527543e-12, 0.025997841389501893], [9.347844529888832e-12, 0.02638007323065639], [9.354510253259692e-12, 0.02676176038198501], [9.361177013400146e-12, 0.027142903922417534], [9.367844808327024e-12, 0.02752350492827514], [9.374513636061831e-12, 0.027903564473277423], [9.381183494630744e-12, 0.028283083628549387], [9.387854382064593e-12, 0.028662063462628437], [9.394526296398851e-12, 0.02904050504147134], [9.401199235673623e-12, 0.029418409428461176], [9.407873197933628e-12, 0.029795777684414246], [9.414548181228194e-12, 0.030172610867587005], [9.421224183611242e-12, 0.030548910033682927], [9.427901203141273e-12, 0.030924676235859396], [9.434579237881355e-12, 0.03129991052473454], [9.441258285899116e-12, 0.03167461394839408], [9.447938345266725e-12, 0.032048787552398136], [9.454619414060886e-12, 0.032422432379788015], [9.461301490362823e-12, 0.03279554947109301], [9.467984572258267e-12, 0.03316813986433716]], "velocities": [], "times": [0.0, 2.9724985288786825e-24, 6.242196123395033e-24, 9.838802035611883e-24, 1.3794994208931524e-23, 1.8146715679300398e-23, 2.2933500518659845e-23, 2.8198832254442867e-23, 3.399053798805022e-23, 4.0361221752407935e-23, 4.7368740996536836e-23, 5.507673046640184e-23, 6.355517816924757e-23, 7.288105856651497e-23, 8.313902864189356e-23, 9.442219304000695e-23, 1.068329450718675e-22, 1.2048389104010224e-22, 1.3549886605490771e-22, 1.5201405029593487e-22, 1.7017919553139068e-22, 1.901589726394689e-22, 2.121344518950492e-22, 2.3630472889303335e-22, 2.628887101856729e-22, 2.921270740220478e-22, 3.218072007462031e-22, 3.514830047689024e-22, 3.8115449294248137e-22, 4.1082167210466717e-22, 4.40484549078615e-22, 4.701431306729445e-22, 4.997974236817753e-22, 5.294474348847635e-22, 5.590931710471378e-22, 5.887346389197347e-22, 6.183718452390352e-22, 6.480047967271993e-22, 6.77633500092103e-22, 7.072579620273725e-22, 7.368781892124205e-22, 7.664941883124809e-22, 7.9610596597864465e-22, 8.257135288478945e-22, 8.553168835431398e-22, 8.849160366732523e-22, 9.145109948331001e-22, 9.441017646035831e-22, 9.736883525516674e-22, 1.0032707652304198e-21, 1.0328490091790426e-21, 1.062423090922908e-21, 1.0919930169735923e-21, 1.1215587938289098e-21, 1.1511204279729484e-21, 1.1806779258761012e-21, 1.2102312939951033e-21, 1.2397805387730636e-21, 1.2693256666394996e-21, 1.2988666840103708e-21, 1.3284035972881127e-21, 1.3579364128616695e-21, 1.3874651371065291e-21, 1.416989776384755e-21, 1.44651033704502e-21, 1.4760268254226397e-21, 1.5055392478396058e-21, 1.5350476106046189e-21, 1.5645519200131206e-21, 1.5940521823473283e-21, 1.623548403876266e-21, 1.6530405908557986e-21, 1.6825287495286627e-21, 1.7120128861245015e-21, 1.7414930068598946e-21, 1.770969117938393e-21, 1.80044122555055e-21, 1.8299093358739522e-21, 1.8593734550732546e-21, 1.8888335893002096e-21, 1.9182897446937013e-21, 1.9477419273797754e-21, 1.9771901434716732e-21, 2.006634399069861e-21, 2.036074700262063e-21, 2.0655110531232933e-21, 2.094943463715885e-21, 2.124371938089525e-21, 2.1537964822812823e-21, 2.1832171023156413e-21, 2.2126338042045316e-21, 2.2420465939473593e-21, 2.2714554775310386e-21, 2.3008604609300217e-21, 2.33026155010633e-21, 2.3596587510095865e-21, 2.3890520695770424e-21, 2.4184415117336126e-21, 2.447827083391902e-21, 2.477208790452238e-21], "losses": []}}, "proton": {"theory": {"positions": [[8.9113923229424e-12, 0.0], [8.911392324244393e-12, -2.0165608136966357e-05], [8.911392328684194e-12, -4.234777707386936e-05], [8.911392337207182e-12, -6.674816287003563e-05], [8.911392350985908e-12, -9.35885871805e-05], [8.911392371470666e-12, -0.00012311305381148153], [8.911392400450974e-12, -0.0001555899669299025], [8.911392440130272e-12, -0.00019131457109182524], [8.911392493216662e-12, -0.00023061163527098757], [8.911392563033078e-12, -0.00027383840528649224], [8.91139265365101e-12, -0.00032138785146828533], [8.911392770052783e-12, -0.0003736922410824875], [8.911392918328415e-12, -0.00043122706799026555], [8.91139310591436e-12, -0.000494515375260524], [8.91139334188303e-12, -0.0005641325100276844], [8.911393637293759e-12, -0.0006407113538135627], [8.911394005618245e-12, -0.0007249480758524025], [8.911394463256122e-12, -0.0008176084617095605], [8.911395030159721e-12, -0.000919534874710095], [8.911395730591016e-12, -0.0010316539134407373], [8.911396594038604e-12, -0.0011549848349092157], [8.911397656328462e-12, -0.0012906488198954828], [8.911398960969272e-12, -0.0014398791646724383], [8.911400560781704e-12, -0.0016040324916776116], [8.911402519871452e-12, -0.0017846010809569135], [8.911404916018338e-12, -0.0019832264343590173], [8.911407607162712e-12, -0.0021848818995795077], [8.911410558705355e-12, -0.002386537239886268], [8.911413770646136e-12, -0.002588192443750416], [8.911417242984916e-12, -0.0027898474996431097], [8.911420975721542e-12, -0.0029915023960355516], [8.911424968855852e-12, -0.0031931571213989923], [8.911429222387667e-12, -0.0033948116642047335], [8.911433736316803e-12, -0.0035964660129241322], [8.91143851064306e-12, -0.003798120156028603], [8.911443545366229e-12, -0.003999774081989623], [8.91144884048609e-12, -0.004201427779278733], [8.911454396002408e-12, -0.004403081236367544], [8.911460211914942e-12, -0.004604734441727739], [8.911466288223433e-12, -0.004806387383831075], [8.91147262492762e-12, -0.0050080400511493895], [8.911479222027218e-12, -0.005209692432154602], [8.911486079521943e-12, -0.005411344515318718], [8.911493197411494e-12, -0.005612996289113831], [8.911500575695555e-12, -0.005814647742012131], [8.911508214373804e-12, -0.006016298862485899], [8.911516113445906e-12, -0.006217949639007521], [8.911524272911513e-12, -0.006419600060049483], [8.911532692770268e-12, -0.006621250114084379], [8.9115413730218e-12, -0.006822899789584912], [8.911550313665726e-12, -0.007024549075023899], [8.91155951470166e-12, -0.007226197958874275], [8.911568976129194e-12, -0.007427846429609095], [8.911578697947912e-12, -0.007629494475701537], [8.911588680157387e-12, -0.007831142085624907], [8.911598922757183e-12, -0.008032789247852643], [8.911609425746848e-12, -0.008234435950858316], [8.911620189125924e-12, -0.008436082183115635], [8.911631212893936e-12, -0.00863772793309845], [8.911642497050403e-12, -0.008839373189280759], [8.911654041594825e-12, -0.009041017940136703], [8.911665846526698e-12, -0.009242662174140577], [8.911677911845503e-12, -0.009444305879766832], [8.911690237550713e-12, -0.009645949045490076], [8.911702823641785e-12, -0.009847591659785078], [8.911715670118163e-12, -0.010049233711126777], [8.91172877697929e-12, -0.010250875187990276], [8.911742144224585e-12, -0.010452516078850853], [8.911755771853463e-12, -0.010654156372183962], [8.911769659865328e-12, -0.010855796056465234], [8.911783808259565e-12, -0.011057435120170486], [8.911798217035559e-12, -0.011259073551775717], [8.911812886192675e-12, -0.01146071133975712], [8.911827815730267e-12, -0.01166234847259108], [8.911843005647681e-12, -0.011863984938754176], [8.91185845594425e-12, -0.01206562072672319], [8.911874166619299e-12, -0.012267255824975105], [8.911890137672132e-12, -0.012468890221987113], [8.911906369102054e-12, -0.012670523906236615], [8.91192286090835e-12, -0.012872156866201226], [8.911939613090296e-12, -0.01307378909035878], [8.911956625647157e-12, -0.013275420567187331], [8.911973898578187e-12, -0.013477051285165156], [8.911991431882626e-12, -0.013678681232770759], [8.912009225559704e-12, -0.013880310398482879], [8.912027279608643e-12, -0.014081938770780485], [8.912045594028647e-12, -0.014283566338142787], [8.912064168818917e-12, -0.014485193089049237], [8.912083003978634e-12, -0.014686819011979529], [8.912102099506973e-12, -0.014888444095413605], [8.912121455403095e-12, -0.015090068327831663], [8.912141071666151e-12, -0.015291691697714153], [8.91216094829528e-12, -0.015493314193541786], [8.912181085289608e-12, -0.015694935803795534], [8.912201482648252e-12, -0.015896556516956633], [8.912222140370319e-12, -0.01609817632150659], [8.9122430584549e-12, -0.016299795205927187], [8.912264236901078e-12, -0.016501413158700476], [8.912285675707921e-12, -0.016703030168308795], [8.912307374874491e-12, -0.01690464622323476]], "velocities": [], "times": [0.0, 2.8073357668693167e-24, 5.895405110224602e-24, 9.292281387412613e-24, 1.3028845291365457e-23, 1.713906558409932e-23, 2.1660307903541088e-23, 2.663367445100795e-23, 3.2104377647394846e-23, 3.812215115492661e-23, 4.4741702001012635e-23, 5.202320791438923e-23, 6.00328643947448e-23, 6.88434864891314e-23, 7.853517074578105e-23, 8.91960233629871e-23, 1.0092296115244965e-22, 1.138225925983882e-22, 1.2801218702180649e-22, 1.4362074066016924e-22, 1.607901493536906e-22, 1.7967649849843974e-22, 2.004514819923385e-22, 2.2330396307252903e-22, 2.484416912321686e-22, 2.7609319082315296e-22, 3.041665394930526e-22, 3.3223988633859955e-22, 3.603132311914154e-22, 3.8838657388312207e-22, 4.164599142453423e-22, 4.445332521096991e-22, 4.726065873078163e-22, 5.006799196713184e-22, 5.287532490318308e-22, 5.568265752209795e-22, 5.848998980703912e-22, 6.129732174116937e-22, 6.410465330765156e-22, 6.691198448964864e-22, 6.971931527032367e-22, 7.252664563283982e-22, 7.533397556036034e-22, 7.814130503604862e-22, 8.094863404306816e-22, 8.3755962564582565e-22, 8.65632905837556e-22, 8.937061808375111e-22, 9.217794504773313e-22, 9.49852714588658e-22, 9.779259730031341e-22, 1.0059992255524038e-21, 1.0340724720681134e-21, 1.0621457123819099e-21, 1.0902189463254423e-21, 1.1182921737303618e-21, 1.1463653944283205e-21, 1.1744386082509722e-21, 1.2025118150299734e-21, 1.2305850145969816e-21, 1.2586582067836562e-21, 1.2867313914216589e-21, 1.314804568342653e-21, 1.342877737378304e-21, 1.3709508983602795e-21, 1.3990240511202492e-21, 1.4270971954898845e-21, 1.4551703313008593e-21, 1.4832434583848497e-21, 1.5113165765735342e-21, 1.5393896856985931e-21, 1.5674627855917096e-21, 1.5955358760845692e-21, 1.6236089570088593e-21, 1.6516820281962703e-21, 1.679755089478495e-21, 1.707828140687229e-21, 1.73590118165417e-21, 1.763974212211019e-21, 1.7920472321894783e-21, 1.820120241421255e-21, 1.8481932397380577e-21, 1.8762662269715974e-21, 1.9043392029535896e-21, 1.9324121675157504e-21, 1.9604851204898014e-21, 1.988558061707465e-21, 2.016630991000468e-21, 2.0447039082005405e-21, 2.0727768131394145e-21, 2.1008497056488253e-21, 2.1289225855605124e-21, 2.156995452706218e-21, 2.185068306917688e-21, 2.213141148026671e-21, 2.2412139758649186e-21, 2.269286790264187e-21, 2.2973595910562356e-21, 2.3254323780728273e-21, 2.353505151145728e-21], "losses": []}}};
        const THEORY_NAME = 'Kerr';
        const BLACK_HOLE_MASS = 99450000000000.0;
        
        // Particle colors
        const PARTICLE_COLORS = {
            electron: { 
                theory: [0.29, 0.62, 1.0, 1.0],  // Blue
                kerr: [0.29, 0.62, 1.0, 0.5]      // Blue (transparent)
            },
            neutrino: { 
                theory: [0.96, 0.26, 0.21, 1.0],  // Red
                kerr: [0.96, 0.26, 0.21, 0.5]     // Red (transparent)
            },
            photon: { 
                theory: [0.98, 0.74, 0.02, 1.0],  // Yellow
                kerr: [0.98, 0.74, 0.02, 0.5]     // Yellow (transparent)
            },
            proton: { 
                theory: [0.18, 0.80, 0.44, 1.0],  // Green
                kerr: [0.18, 0.80, 0.44, 0.5]     // Green (transparent)
            }
        };
        
        // Track which particles are enabled
        const particleEnabled = {};
        
        // WebGL setup
        const canvas = document.getElementById('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        
        if (!gl) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').innerHTML = 'WebGL not supported in your browser.';
            document.getElementById('error').style.display = 'block';
        }
        
        // Resize canvas
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            gl.viewport(0, 0, canvas.width, canvas.height);
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // Shader sources
        const vertexShaderSource = `
            attribute vec2 a_position;
            uniform mat3 u_matrix;
            uniform float u_pointSize;
            
            void main() {
                vec3 position = u_matrix * vec3(a_position, 1.0);
                gl_Position = vec4(position.xy, 0.0, 1.0);
                gl_PointSize = u_pointSize;
            }
        `;
        
        const fragmentShaderSource = `
            precision mediump float;
            uniform vec4 u_color;
            uniform float u_isPoint;
            
            void main() {
                if (u_isPoint > 0.5) {
                    // Draw circular point
                    vec2 coord = gl_PointCoord - vec2(0.5);
                    if (length(coord) > 0.5) {
                        discard;
                    }
                }
                gl_FragColor = u_color;
            }
        `;
        
        // Create shaders
        function createShader(gl, type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                console.error('Shader compilation error:', gl.getShaderInfoLog(shader));
                gl.deleteShader(shader);
                return null;
            }
            return shader;
        }
        
        const vertexShader = createShader(gl, gl.VERTEX_SHADER, vertexShaderSource);
        const fragmentShader = createShader(gl, gl.FRAGMENT_SHADER, fragmentShaderSource);
        
        // Create program
        const program = gl.createProgram();
        gl.attachShader(program, vertexShader);
        gl.attachShader(program, fragmentShader);
        gl.linkProgram(program);
        
        if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
            console.error('Program linking error:', gl.getProgramInfoLog(program));
        }
        
        // Get locations
        const positionLocation = gl.getAttribLocation(program, 'a_position');
        const matrixLocation = gl.getUniformLocation(program, 'u_matrix');
        const colorLocation = gl.getUniformLocation(program, 'u_color');
        const pointSizeLocation = gl.getUniformLocation(program, 'u_pointSize');
        const isPointLocation = gl.getUniformLocation(program, 'u_isPoint');
        
        // Create buffer
        const positionBuffer = gl.createBuffer();
        
        // Animation state
        let currentStep = 0;
        let isPlaying = true;
        let showTrail = true;
        let showGrid = true;
        let cameraX = 0;
        let cameraY = 0;
        let cameraZoom = 1;
        let animationSpeed = 3;
        
        // Calculate bounds from all particle data
        function calculateBounds() {
            let minX = Infinity, maxX = -Infinity;
            let minY = Infinity, maxY = -Infinity;
            
            if (PARTICLE_DATA) {
                Object.keys(PARTICLE_DATA).forEach(particleName => {
                    const particleData = PARTICLE_DATA[particleName];
                    ['theory', 'kerr'].forEach(dataType => {
                        const data = particleData[dataType];
                        if (data && data.positions) {
                            data.positions.forEach(pos => {
                                const x = pos[0] * Math.cos(pos[1]);
                                const y = pos[0] * Math.sin(pos[1]);
                                minX = Math.min(minX, x);
                                maxX = Math.max(maxX, x);
                                minY = Math.min(minY, y);
                                maxY = Math.max(maxY, y);
                            });
                        }
                    });
                });
            }
            
            const scale = Math.max(maxX - minX, maxY - minY) * 1.2;
            return { minX, maxX, minY, maxY, scale: scale || 100 };
        }
        
        // Matrix operations
        function createMatrix(tx, ty, scale) {
            const aspect = canvas.width / canvas.height;
            return [
                2 * scale / canvas.width, 0, 0,
                0, -2 * scale / canvas.height, 0,
                tx, ty, 1
            ];
        }
        
        // Draw scene
        function drawScene() {
            gl.clearColor(0.04, 0.04, 0.04, 1.0);
            gl.clear(gl.COLOR_BUFFER_BIT);
            
            gl.useProgram(program);
            
            const bounds = calculateBounds();
            const matrix = createMatrix(
                -cameraX / bounds.scale,
                -cameraY / bounds.scale,
                cameraZoom / bounds.scale
            );
            gl.uniformMatrix3fv(matrixLocation, false, matrix);
            
            // Draw grid
            if (showGrid) {
                drawGrid();
            }
            
            // Draw black hole
            drawBlackHole();
            
            // Draw all particle trajectories
            if (PARTICLE_DATA) {
                Object.keys(PARTICLE_DATA).forEach(particleName => {
                    if (particleEnabled[particleName]) {
                        const particleData = PARTICLE_DATA[particleName];
                        const colors = PARTICLE_COLORS[particleName];
                        
                        // Draw Kerr baseline (dashed)
                        if (particleData.kerr && particleData.kerr.positions) {
                            drawTrajectory(particleData.kerr, colors.kerr, currentStep, true);
                        }
                        
                        // Draw theory trajectory (solid)
                        if (particleData.theory && particleData.theory.positions) {
                            drawTrajectory(particleData.theory, colors.theory, currentStep, false);
                        }
                        
                        // Draw current positions
                        if (particleData.theory && particleData.theory.positions && 
                            currentStep < particleData.theory.positions.length) {
                            drawParticle(particleData.theory.positions[currentStep], colors.theory);
                        }
                        if (particleData.kerr && particleData.kerr.positions && 
                            currentStep < particleData.kerr.positions.length) {
                            drawParticle(particleData.kerr.positions[currentStep], colors.kerr);
                        }
                    }
                });
            }
        }
        
        function drawGrid() {
            const gridSize = 10;
            const gridLines = [];
            
            for (let i = -100; i <= 100; i += gridSize) {
                // Vertical lines
                gridLines.push(i, -100, i, 100);
                // Horizontal lines
                gridLines.push(-100, i, 100, i);
            }
            
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(gridLines), gl.STATIC_DRAW);
            gl.enableVertexAttribArray(positionLocation);
            gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
            
            gl.uniform4f(colorLocation, 0.2, 0.2, 0.2, 0.3);
            gl.uniform1f(isPointLocation, 0.0);
            
            for (let i = 0; i < gridLines.length / 4; i++) {
                gl.drawArrays(gl.LINES, i * 2, 2);
            }
        }
        
        function drawBlackHole() {
            const segments = 64;
            const vertices = [];
            
            // Event horizon (r = 2M)
            const r_horizon = 2;
            for (let i = 0; i <= segments; i++) {
                const angle = (i / segments) * Math.PI * 2;
                vertices.push(r_horizon * Math.cos(angle), r_horizon * Math.sin(angle));
            }
            
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
            gl.enableVertexAttribArray(positionLocation);
            gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
            
            gl.uniform4f(colorLocation, 1.0, 1.0, 1.0, 0.5);
            gl.uniform1f(isPointLocation, 0.0);
            gl.drawArrays(gl.LINE_LOOP, 0, vertices.length / 2);
        }
        
        function drawTrajectory(data, color, upToStep, isDashed) {
            if (!data.positions || data.positions.length === 0) return;
            
            const vertices = [];
            const limit = showTrail ? upToStep : Math.max(0, upToStep - 50);
            
            for (let i = Math.max(0, limit); i <= upToStep && i < data.positions.length; i++) {
                const pos = data.positions[i];
                const x = pos[0] * Math.cos(pos[1]);
                const y = pos[0] * Math.sin(pos[1]);
                vertices.push(x, y);
            }
            
            if (vertices.length > 2) {
                gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
                gl.enableVertexAttribArray(positionLocation);
                gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
                
                const alpha = showTrail ? color[3] : color[3] * 0.5;
                gl.uniform4f(colorLocation, color[0], color[1], color[2], alpha);
                gl.uniform1f(isPointLocation, 0.0);
                
                if (isDashed) {
                    // Draw dashed line for Kerr baseline
                    for (let i = 0; i < vertices.length / 2 - 1; i += 2) {
                        gl.drawArrays(gl.LINES, i, 2);
                    }
                } else {
                    gl.drawArrays(gl.LINE_STRIP, 0, vertices.length / 2);
                }
            }
        }
        
        function drawParticle(position, color) {
            const x = position[0] * Math.cos(position[1]);
            const y = position[0] * Math.sin(position[1]);
            
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([x, y]), gl.STATIC_DRAW);
            gl.enableVertexAttribArray(positionLocation);
            gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
            
            gl.uniform4f(colorLocation, color[0], color[1], color[2], color[3]);
            gl.uniform1f(pointSizeLocation, 8.0);
            gl.uniform1f(isPointLocation, 1.0);
            gl.drawArrays(gl.POINTS, 0, 1);
        }
        
        // Update info panel
        function updateInfo() {
            let maxSteps = 0;
            let currentTime = 0;
            
            if (PARTICLE_DATA) {
                Object.keys(PARTICLE_DATA).forEach(particleName => {
                    const particleData = PARTICLE_DATA[particleName];
                    if (particleData.theory && particleData.theory.positions) {
                        maxSteps = Math.max(maxSteps, particleData.theory.positions.length);
                        if (particleData.theory.times && currentStep < particleData.theory.times.length) {
                            currentTime = Math.max(currentTime, particleData.theory.times[currentStep]);
                        }
                    }
                });
            }
            
            document.getElementById('stepInfo').textContent = `${currentStep} / ${maxSteps}`;
            document.getElementById('timeInfo').textContent = currentTime.toExponential(2);
        }
        
        // Setup particle legend
        function setupParticleLegend() {
            const legend = document.getElementById('particleLegend');
            
            if (PARTICLE_DATA) {
                Object.keys(PARTICLE_DATA).forEach(particleName => {
                    const colors = PARTICLE_COLORS[particleName];
                    particleEnabled[particleName] = true; // Enable all by default
                    
                    const item = document.createElement('div');
                    item.className = 'particle-item';
                    item.innerHTML = `
                        <div class="color-box" style="background: rgb(${Math.round(colors.theory[0]*255)}, ${Math.round(colors.theory[1]*255)}, ${Math.round(colors.theory[2]*255)})"></div>
                        <div>${particleName}</div>
                    `;
                    
                    item.onclick = () => {
                        particleEnabled[particleName] = !particleEnabled[particleName];
                        item.classList.toggle('disabled', !particleEnabled[particleName]);
                    };
                    
                    legend.appendChild(item);
                });
            }
        }
        
        // Animation loop
        function animate() {
            if (isPlaying) {
                currentStep += animationSpeed;
                
                // Find max steps across all particles
                let maxSteps = 0;
                if (PARTICLE_DATA) {
                    Object.values(PARTICLE_DATA).forEach(particleData => {
                        if (particleData.theory && particleData.theory.positions) {
                            maxSteps = Math.max(maxSteps, particleData.theory.positions.length);
                        }
                    });
                }
                
                if (currentStep >= maxSteps - 1) {
                    currentStep = maxSteps - 1;
                    isPlaying = false;
                    document.getElementById('playPause').textContent = 'Play';
                }
            }
            
            drawScene();
            updateInfo();
            requestAnimationFrame(animate);
        }
        
        // Controls
        document.getElementById('playPause').addEventListener('click', () => {
            isPlaying = !isPlaying;
            document.getElementById('playPause').textContent = isPlaying ? 'Pause' : 'Play';
        });
        
        document.getElementById('reset').addEventListener('click', () => {
            currentStep = 0;
            isPlaying = false;
            document.getElementById('playPause').textContent = 'Play';
        });
        
        document.getElementById('speed').addEventListener('input', (e) => {
            animationSpeed = parseFloat(e.target.value);
        });
        
        document.getElementById('zoom').addEventListener('input', (e) => {
            cameraZoom = parseFloat(e.target.value);
        });
        
        document.getElementById('toggleTrail').addEventListener('click', (e) => {
            showTrail = !showTrail;
            e.target.classList.toggle('active', showTrail);
        });
        
        document.getElementById('toggleGrid').addEventListener('click', (e) => {
            showGrid = !showGrid;
            e.target.classList.toggle('active', showGrid);
        });
        
        // Mouse controls
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        
        canvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const dx = e.clientX - lastMouseX;
                const dy = e.clientY - lastMouseY;
                cameraX += dx * 2;
                cameraY += dy * 2;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
            }
        });
        
        canvas.addEventListener('mouseup', () => {
            isDragging = false;
        });
        
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const scaleFactor = e.deltaY > 0 ? 0.9 : 1.1;
            cameraZoom *= scaleFactor;
            cameraZoom = Math.max(0.1, Math.min(10, cameraZoom));
            document.getElementById('zoom').value = cameraZoom;
        });
        
        // Initialize
        document.getElementById('loading').style.display = 'none';
        document.getElementById('toggleTrail').classList.add('active');
        document.getElementById('toggleGrid').classList.add('active');
        setupParticleLegend();
        animate();
    </script>
</body>
</html>