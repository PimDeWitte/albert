<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schwarzschild - Multi-Particle Trajectory Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0a0a0a;
            color: #fff;
            overflow: hidden;
        }
        
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            max-width: 300px;
        }
        
        h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        
        .button {
            background: #2980b9;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 2px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .button:hover {
            background: #3498db;
        }
        
        .button.active {
            background: #27ae60;
        }
        
        input[type="range"] {
            width: 200px;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
        }
        
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #e74c3c;
            display: none;
        }
        
        .particle-legend {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .particle-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            cursor: pointer;
        }
        
        .particle-item:hover {
            opacity: 0.8;
        }
        
        .particle-item.disabled {
            opacity: 0.3;
        }
        
        .color-box {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
        }
        
        .stats {
            font-size: 12px;
            color: #999;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div id="loading">Loading trajectories...</div>
    <div id="error"></div>
    
    <div class="controls">
        <h3>Controls</h3>
        <div>
            <button class="button" id="playPause">Play</button>
            <button class="button" id="reset">Reset</button>
        </div>
        <div style="margin-top: 10px;">
            <label>Speed: <input type="range" id="speed" min="0" max="10" value="3" step="0.1"></label>
        </div>
        <div style="margin-top: 10px;">
            <label>Zoom: <input type="range" id="zoom" min="0.1" max="10" value="1" step="0.1"></label>
        </div>
        <div style="margin-top: 10px;">
            <button class="button" id="toggleTrail">Show Trail</button>
            <button class="button" id="toggleGrid">Show Grid</button>
        </div>
    </div>
    
    <div class="info">
        <h3>Schwarzschild</h3>
        <div>Black Hole Mass: 99450000000000.0 kg</div>
        <div>Step: <span id="stepInfo">0 / 0</span></div>
        <div>Time: <span id="timeInfo">0.00e+00</span> s</div>
        
        <div class="particle-legend" id="particleLegend">
            <h4>Particles (click to toggle)</h4>
        </div>
        
        <div class="stats" id="stats"></div>
    </div>

    <script>
        // Multi-particle trajectory data will be injected here
        const PARTICLE_DATA = {"electron": {"theory": {"positions": [[8.9113923229424e-12, 0.0], [8.9113923229424e-12, -0.00027777777777777783], [8.9113923229424e-12, -0.0005555555555555557], [8.9113923229424e-12, -0.0008333333333333335], [8.911392322942398e-12, -0.0011111111111111113], [8.911392322942398e-12, -0.0013888888888888892], [8.9113923229424e-12, -0.001666666666666667], [8.911392322942401e-12, -0.0019444444444444446], [8.911392322942401e-12, -0.0022222222222222222], [8.911392322942403e-12, -0.0024999999999999996], [8.911392322942403e-12, -0.002777777777777777], [8.911392322942403e-12, -0.0030555555555555544], [8.911392322942403e-12, -0.003333333333333332], [8.911392322942403e-12, -0.003611111111111109], [8.911392322942403e-12, -0.0038888888888888866], [8.911392322942403e-12, -0.004166666666666664], [8.911392322942401e-12, -0.004444444444444442], [8.911392322942401e-12, -0.00472222222222222], [8.9113923229424e-12, -0.0049999999999999975], [8.911392322942398e-12, -0.005277777777777775], [8.9113923229424e-12, -0.005555555555555553], [8.911392322942401e-12, -0.005833333333333331], [8.911392322942401e-12, -0.006111111111111109], [8.911392322942403e-12, -0.006388888888888887], [8.911392322942403e-12, -0.0066666666666666645], [8.911392322942403e-12, -0.006944444444444442], [8.911392322942403e-12, -0.00722222222222222], [8.911392322942403e-12, -0.007499999999999998], [8.911392322942403e-12, -0.007777777777777776], [8.911392322942401e-12, -0.008055555555555554], [8.911392322942401e-12, -0.008333333333333331], [8.9113923229424e-12, -0.00861111111111111], [8.911392322942398e-12, -0.008888888888888887], [8.9113923229424e-12, -0.009166666666666665], [8.911392322942401e-12, -0.009444444444444443], [8.911392322942401e-12, -0.00972222222222222], [8.911392322942403e-12, -0.009999999999999998], [8.911392322942403e-12, -0.010277777777777776], [8.911392322942403e-12, -0.010555555555555554], [8.911392322942403e-12, -0.010833333333333332], [8.911392322942403e-12, -0.01111111111111111], [8.911392322942403e-12, -0.011388888888888888], [8.911392322942403e-12, -0.011666666666666665], [8.911392322942401e-12, -0.011944444444444443], [8.911392322942401e-12, -0.012222222222222221], [8.9113923229424e-12, -0.012499999999999999], [8.911392322942398e-12, -0.012777777777777777], [8.9113923229424e-12, -0.013055555555555555], [8.911392322942401e-12, -0.013333333333333332], [8.911392322942401e-12, -0.01361111111111111], [8.911392322942403e-12, -0.013888888888888888], [8.911392322942403e-12, -0.014166666666666666], [8.911392322942403e-12, -0.014444444444444444], [8.911392322942403e-12, -0.014722222222222222], [8.911392322942403e-12, -0.015], [8.911392322942403e-12, -0.015277777777777777], [8.911392322942401e-12, -0.015555555555555555], [8.911392322942401e-12, -0.01583333333333333], [8.9113923229424e-12, -0.016111111111111107], [8.911392322942398e-12, -0.016388888888888883], [8.9113923229424e-12, -0.016666666666666663], [8.911392322942401e-12, -0.01694444444444444], [8.911392322942401e-12, -0.017222222222222215], [8.911392322942403e-12, -0.01749999999999999], [8.911392322942403e-12, -0.017777777777777767], [8.911392322942403e-12, -0.018055555555555543], [8.911392322942403e-12, -0.01833333333333332], [8.911392322942403e-12, -0.018611111111111096], [8.911392322942403e-12, -0.018888888888888872], [8.911392322942403e-12, -0.019166666666666648], [8.911392322942401e-12, -0.019444444444444424], [8.911392322942401e-12, -0.0197222222222222], [8.9113923229424e-12, -0.019999999999999976], [8.911392322942398e-12, -0.020277777777777756], [8.9113923229424e-12, -0.020555555555555535], [8.911392322942401e-12, -0.02083333333333331], [8.911392322942401e-12, -0.021111111111111087], [8.911392322942403e-12, -0.021388888888888864], [8.911392322942403e-12, -0.02166666666666664], [8.911392322942403e-12, -0.021944444444444416], [8.911392322942403e-12, -0.022222222222222192], [8.911392322942403e-12, -0.022499999999999968], [8.911392322942403e-12, -0.022777777777777744], [8.911392322942401e-12, -0.02305555555555552], [8.911392322942401e-12, -0.023333333333333296], [8.9113923229424e-12, -0.023611111111111072], [8.911392322942398e-12, -0.02388888888888885], [8.9113923229424e-12, -0.024166666666666628], [8.911392322942401e-12, -0.024444444444444404], [8.911392322942401e-12, -0.02472222222222218], [8.911392322942403e-12, -0.024999999999999956], [8.911392322942403e-12, -0.025277777777777732], [8.911392322942403e-12, -0.02555555555555551], [8.911392322942403e-12, -0.025833333333333285], [8.911392322942403e-12, -0.02611111111111106], [8.911392322942403e-12, -0.026388888888888837], [8.911392322942403e-12, -0.026666666666666613], [8.911392322942401e-12, -0.02694444444444439], [8.911392322942401e-12, -0.027222222222222165], [8.9113923229424e-12, -0.02749999999999994], [8.911392322942398e-12, -0.02777777777777772]], "velocities": [], "times": [0.0, 2.8603092012548004e-23, 5.720618402509601e-23, 8.580927603764401e-23, 1.1441236805019201e-22, 1.4301546006274002e-22, 1.7161855207528802e-22, 2.0022164408783603e-22, 2.2882473610038403e-22, 2.5742782811293206e-22, 2.860309201254801e-22, 3.146340121380281e-22, 3.4323710415057614e-22, 3.7184019616312417e-22, 4.0044328817567215e-22, 4.290463801882202e-22, 4.5764947220076825e-22, 4.862525642133163e-22, 5.148556562258643e-22, 5.434587482384122e-22, 5.720618402509603e-22, 6.006649322635083e-22, 6.292680242760563e-22, 6.5787111628860425e-22, 6.864742083011523e-22, 7.150773003137002e-22, 7.436803923262481e-22, 7.722834843387961e-22, 8.008865763513441e-22, 8.29489668363892e-22, 8.580927603764399e-22, 8.866958523889879e-22, 9.15298944401536e-22, 9.439020364140838e-22, 9.725051284266318e-22, 1.0011082204391798e-21, 1.0297113124517277e-21, 1.0583144044642757e-21, 1.0869174964768235e-21, 1.1155205884893716e-21, 1.1441236805019196e-21, 1.1727267725144674e-21, 1.2013298645270155e-21, 1.2299329565395633e-21, 1.2585360485521113e-21, 1.2871391405646593e-21, 1.3157422325772072e-21, 1.3443453245897552e-21, 1.372948416602303e-21, 1.401551508614851e-21, 1.4301546006273991e-21, 1.458757692639947e-21, 1.487360784652495e-21, 1.5159638766650428e-21, 1.5445669686775908e-21, 1.5731700606901389e-21, 1.6017731527026867e-21, 1.6303762447152347e-21, 1.6589793367277826e-21, 1.6875824287403306e-21, 1.7161855207528786e-21, 1.7447886127654265e-21, 1.7733917047779743e-21, 1.8019947967905225e-21, 1.8305978888030704e-21, 1.8592009808156182e-21, 1.8878040728281664e-21, 1.9164071648407143e-21, 1.945010256853262e-21, 1.9736133488658103e-21, 2.002216440878358e-21, 2.030819532890906e-21, 2.059422624903454e-21, 2.088025716916002e-21, 2.11662880892855e-21, 2.1452319009410977e-21, 2.173834992953646e-21, 2.2024380849661938e-21, 2.2310411769787416e-21, 2.25964426899129e-21, 2.2882473610038377e-21, 2.3168504530163855e-21, 2.3454535450289333e-21, 2.3740566370414816e-21, 2.4026597290540294e-21, 2.4312628210665772e-21, 2.4598659130791255e-21, 2.4884690050916737e-21, 2.5170720971042215e-21, 2.5456751891167693e-21, 2.5742782811293176e-21, 2.6028813731418654e-21, 2.6314844651544132e-21, 2.6600875571669615e-21, 2.6886906491795093e-21, 2.717293741192057e-21, 2.745896833204605e-21, 2.774499925217153e-21, 2.803103017229701e-21, 2.831706109242249e-21, 2.860309201254797e-21], "losses": []}}, "neutrino": {"theory": {"positions": [[8.9113923229424e-12, 0.0], [8.904522020843266e-12, 0.00034667744018687663], [8.897652522420897e-12, 0.0006938902214643297], [8.890783829330662e-12, 0.0010416395218955919], [8.883915943232218e-12, 0.0013899265228145955], [8.877048865789511e-12, 0.0017387524088366222], [8.8701825986708e-12, 0.0020881183678689904], [8.863317143548663e-12, 0.0024380255911217808], [8.856452502100017e-12, 0.0027884752731186014], [8.849588676006121e-12, 0.0031394686117073916], [8.842725666952597e-12, 0.0034910068080712645], [8.835863476629442e-12, 0.0038430910667393878], [8.829002106731036e-12, 0.004195722595597906], [8.822141558956166e-12, 0.004548902605900899], [8.815281835008025e-12, 0.004902632312281385], [8.808422936594237e-12, 0.005256912932762357], [8.801564865426862e-12, 0.005611745688767863], [8.794707623222417e-12, 0.005967131805134127], [8.787851211701886e-12, 0.0063230725101207095], [8.780995632590728e-12, 0.006679569035421702], [8.774140887618901e-12, 0.0070366226161769725], [8.767286978520868e-12, 0.007394234490983446], [8.760433907035613e-12, 0.007752405901906426], [8.753581674906652e-12, 0.008111138094490954], [8.746730283882053e-12, 0.008470432317773217], [8.739879735714443e-12, 0.008830289824291992], [8.733030032161024e-12, 0.009190711870100132], [8.72618117498359e-12, 0.009551699714776091], [8.719333165948538e-12, 0.0099132546214355], [8.712486006826877e-12, 0.010275377856742773], [8.705639699394252e-12, 0.010638070690922758], [8.69879424543095e-12, 0.011001334397772441], [8.691949646721921e-12, 0.011365170254672681], [8.685105905056784e-12, 0.011729579542599983], [8.678263022229846e-12, 0.012094563546138328], [8.671421000040115e-12, 0.01246012355349104], [8.664579840291316e-12, 0.01282626085649269], [8.657739544791902e-12, 0.01319297675062105], [8.650900115355073e-12, 0.013560272535009086], [8.644061553798782e-12, 0.013928149512457], [8.637223861945762e-12, 0.014296608989444308], [8.630387041623524e-12, 0.014665652276141972], [8.623551094664389e-12, 0.015035280686424561], [8.616716022905492e-12, 0.015405495537882471], [8.609881828188798e-12, 0.01577629815183418], [8.603048512361114e-12, 0.01614768985333855], [8.596216077274114e-12, 0.01651967197120718], [8.58938452478434e-12, 0.01689224583801679], [8.58255385675323e-12, 0.01726541279012166], [8.575724075047122e-12, 0.01763917416766611], [8.568895181537273e-12, 0.018013531314597035], [8.56206717809988e-12, 0.018388485578676467], [8.55524006661608e-12, 0.018764038311494195], [8.548413848971982e-12, 0.01914019086848043], [8.541588527058667e-12, 0.019516944608918518], [8.53476410277222e-12, 0.01989430089595769], [8.527940578013727e-12, 0.020272261096625863], [8.5211179546893e-12, 0.020650826581842495], [8.514296234710098e-12, 0.02102999872643147], [8.507475419992322e-12, 0.021409778909134054], [8.500655512457256e-12, 0.021790168512621857], [8.493836514031265e-12, 0.022171168923509902], [8.487018426645815e-12, 0.02255278153236968], [8.480201252237487e-12, 0.022935007733742296], [8.473384992748001e-12, 0.02331784892615164], [8.466569650124217e-12, 0.02370130651211761], [8.459755226318165e-12, 0.024085381898169396], [8.45294172328705e-12, 0.02447007649485879], [8.446129142993273e-12, 0.024855391716773558], [8.439317487404452e-12, 0.02524132898255087], [8.43250675849342e-12, 0.02562788971489075], [8.425696958238264e-12, 0.026015075340569606], [8.418888088622324e-12, 0.02640288729045378], [8.412080151634214e-12, 0.026791326999513178], [8.40527314926784e-12, 0.027180395906834926], [8.398467083522415e-12, 0.02757009545563708], [8.391661956402477e-12, 0.02796042709328239], [8.3848577699179e-12, 0.028351392271292127], [8.378054526083914e-12, 0.028742992445359918], [8.371252226921118e-12, 0.029135229075365678], [8.364450874455504e-12, 0.029528103625389577], [8.35765047071847e-12, 0.029921617563726046], [8.350851017746828e-12, 0.030315772362897838], [8.34405251758283e-12, 0.030710569499670153], [8.337254972274185e-12, 0.031106010455064798], [8.330458383874069e-12, 0.031502096714374414], [8.323662754441147e-12, 0.03189882976717674], [8.316868086039589e-12, 0.03229621110734894], [8.310074380739084e-12, 0.03269424223308197], [8.303281640614861e-12, 0.033092924646895], [8.296489867747699e-12, 0.033492259855649915], [8.289699064223953e-12, 0.03389224937056583], [8.282909232135563e-12, 0.03429289470723366], [8.276120373580081e-12, 0.03469419738563078], [8.269332490660674e-12, 0.035096158930135714], [8.262545585486152e-12, 0.03549878086954286], [8.255759660170984e-12, 0.035902064737077306], [8.248974716835308e-12, 0.036306012070409656], [8.242190757604961e-12, 0.03671062441167096], [8.235407784611483e-12, 0.037115903307467654], [8.228625799992144e-12, 0.03752185030889659]], "velocities": [], "times": [0.0, 2.972749831677386e-23, 5.945958823137637e-23, 8.919627771962781e-23, 1.189375747769403e-22, 1.4868348741837814e-22, 1.7843402367871883e-22, 2.0818919161251398e-22, 2.3794899929415034e-22, 2.677134548179114e-22, 2.974825662980391e-22, 3.272563418687955e-22, 3.570347896845251e-22, 3.86817917919717e-22, 4.166057347690676e-22, 4.463982484475431e-22, 4.76195467190443e-22, 5.059973992534631e-22, 5.358040529127585e-22, 5.656154364650082e-22, 5.954315582274783e-22, 6.252524265380867e-22, 6.550780497554671e-22, 6.849084362590338e-22, 7.147435944490467e-22, 7.445835327466763e-22, 7.74428259594069e-22, 8.0427778345441265e-22, 8.341321128120027e-22, 8.63991256172308e-22, 8.938552220620371e-22, 9.237240190292049e-22, 9.535976556431995e-22, 9.834761404948494e-22, 1.0133594821964903e-21, 1.0432476893820332e-21, 1.0731407707070317e-21, 1.1030387348487506e-21, 1.1329415905062332e-21, 1.1628493464003717e-21, 1.192762011273974e-21, 1.2226795938918335e-21, 1.2526021030407989e-21, 1.282529547529843e-21, 1.3124619361901335e-21, 1.3423992778751017e-21, 1.3723415814605139e-21, 1.4022888558445417e-21, 1.4322411099478329e-21, 1.4621983527135825e-21, 1.492160593107604e-21, 1.5221278401184012e-21, 1.5521001027572403e-21, 1.5820773900582218e-21, 1.6120597110783528e-21, 1.64204707489762e-21, 1.6720394906190626e-21, 1.702036967368846e-21, 1.732039514296334e-21, 1.7620471405741644e-21, 1.7920598553983215e-21, 1.8220776679882113e-21, 1.8521005875867363e-21, 1.882128623460369e-21, 1.9121617848992293e-21, 1.942200081217158e-21, 1.972243521751794e-21, 2.0022921158646487e-21, 2.0323458729411838e-21, 2.062404802390887e-21, 2.09246891364735e-21, 2.122538216168343e-21, 2.1526127194358964e-21, 2.182692432956375e-21, 2.2127773662605563e-21, 2.2428675289037113e-21, 2.2729629304656804e-21, 2.303063580550954e-21, 2.33316948878875e-21, 2.3632806648330966e-21, 2.3933971183629074e-21, 2.423518859082066e-21, 2.4536458967195036e-21, 2.4837782410292796e-21, 2.513915901790665e-21, 2.5440588888082216e-21, 2.5742072119118834e-21, 2.604360880957041e-21, 2.6345199058246208e-21, 2.6646842964211685e-21, 2.6948540626789344e-21, 2.7250292145559516e-21, 2.7552097620361247e-21, 2.7853957151293102e-21, 2.815587083871401e-21, 2.8457838783244123e-21, 2.875986108576565e-21, 2.9061937847423725e-21, 2.936406916962722e-21, 2.9666255154049652e-21, 2.9968495902630013e-21], "losses": []}}, "photon": {"theory": {"positions": [[8.9113923229424e-12, 0.0], [8.917930501308502e-12, 0.00043269524887310824], [8.924469930390963e-12, 0.0008647564411696251], [8.931010607746917e-12, 0.001296184848793415], [8.937552530939296e-12, 0.0017269817406031082], [8.944095697536807e-12, 0.0021571483824198785], [8.95064010511393e-12, 0.002586686037035206], [8.957185751250883e-12, 0.003015595964218618], [8.963732633533626e-12, 0.0034438794207254167], [8.970280749553834e-12, 0.0038715376603043867], [8.97683009690889e-12, 0.004298571933705486], [8.983380673201861e-12, 0.00472498348868752], [8.989932476041495e-12, 0.005150773570025793], [8.996485503042191e-12, 0.005575943419519754], [9.003039751824e-12, 0.006000494276000612], [9.0095952200126e-12, 0.0064244273753389395], [9.016151905239283e-12, 0.006847743950452262], [9.022709805140944e-12, 0.007270445231312621], [9.029268917360063e-12, 0.007692532444954132], [9.03582923954469e-12, 0.008114006815480511], [9.042390769348432e-12, 0.008534869564072595], [9.048953504430438e-12, 0.00895512190899584], [9.055517442455387e-12, 0.009374765065607802], [9.062082581093468e-12, 0.0097938002463656], [9.06864891802037e-12, 0.010212228660833366], [9.075216450917265e-12, 0.01063005151568967], [9.081785177470795e-12, 0.011047270014734933], [9.08835509537306e-12, 0.011463885358898827], [9.0949262023216e-12, 0.011879898746247645], [9.101498496019381e-12, 0.012295311371991665], [9.108071974174783e-12, 0.012710124428492491], [9.114646634501582e-12, 0.013124339105270383], [9.121222474718945e-12, 0.013537956589011559], [9.127799492551403e-12, 0.013950978063575488], [9.134377685728846e-12, 0.014363404710002166], [9.140957051986503e-12, 0.014775237706519374], [9.14753758906494e-12, 0.015186478228549911], [9.154119294710028e-12, 0.015597127448718823], [9.160702166672942e-12, 0.016007186536860604], [9.167286202710144e-12, 0.016416656660026386], [9.17387140058337e-12, 0.01682553898249111], [9.180457758059613e-12, 0.017233834665760683], [9.187045272911113e-12, 0.017641544868579103], [9.193633942915339e-12, 0.01804867074693559], [9.200223765854977e-12, 0.018455213454071688], [9.206814739517923e-12, 0.018861174140488348], [9.213406861697258e-12, 0.019266553953952992], [9.220000130191241e-12, 0.019671354039506574], [9.226594542803296e-12, 0.02007557553947061], [9.233190097341995e-12, 0.020479219593454192], [9.239786791621048e-12, 0.020882287338361], [9.246384623459286e-12, 0.021284779908396268], [9.252983590680651e-12, 0.02168669843507377], [9.25958369111418e-12, 0.022088044047222758], [9.266184922593993e-12, 0.022488817870994902], [9.272787282959282e-12, 0.022889021029871198], [9.27939077005429e-12, 0.02328865464466888], [9.285995381728307e-12, 0.02368771983354829], [9.292601115835652e-12, 0.024086217712019752], [9.29920797023566e-12, 0.024484149392950422], [9.30581594279267e-12, 0.02488151598657112], [9.312425031376013e-12, 0.025278318600483133], [9.319035233859992e-12, 0.02567455833966504], [9.32564654812388e-12, 0.026070236306479467], [9.332258972051895e-12, 0.026465353600679874], [9.338872503533202e-12, 0.026859911319417295], [9.345487140461887e-12, 0.02725391055724707], [9.352102880736944e-12, 0.027647352406135566], [9.358719722262273e-12, 0.02804023795546687], [9.36533766294666e-12, 0.028432568292049484], [9.371956700703762e-12, 0.028824344500122976], [9.378576833452097e-12, 0.02921556766136464], [9.385198059115037e-12, 0.029606238854896133], [9.391820375620785e-12, 0.02999635915729008], [9.39844378090237e-12, 0.030385929642576685], [9.405068272897629e-12, 0.030774951382250313], [9.411693849549198e-12, 0.031163425445276057], [9.418320508804499e-12, 0.03155135289809629], [9.42494824861573e-12, 0.0319387348046372], [9.43157706693984e-12, 0.03232557222631532], [9.438206961738539e-12, 0.032711866222044], [9.444837930978262e-12, 0.03309761784823994], [9.451469972630173e-12, 0.03348282815882962], [9.458103084670144e-12, 0.03386749820525578], [9.464737265078748e-12, 0.034251629036483835], [9.47137251184124e-12, 0.034635221699008324], [9.478008822947556e-12, 0.03501827723685929], [9.484646196392288e-12, 0.035400796691608685], [9.491284630174679e-12, 0.03578278110237675], [9.497924122298611e-12, 0.03616423150583836], [9.50456467077259e-12, 0.036545148936229364], [9.511206273609736e-12, 0.03692553442535292], [9.51784892882777e-12, 0.03730538900258581], [9.524492634449e-12, 0.0376847136948847], [9.531137388500314e-12, 0.038063509526792466], [9.537783189013167e-12, 0.03844177752044443], [9.544430034023564e-12, 0.0388195186955746], [9.55107792157205e-12, 0.03919673406952193], [9.557726849703705e-12, 0.03957342465723648], [9.564376816468121e-12, 0.03994959147128569], [9.571027819919399e-12, 0.0403252355218605]], "velocities": [], "times": [0.0, 2.972302561880437e-23, 5.944169668694319e-23, 8.915602002610476e-23, 1.1886600244381521e-22, 1.4857165073347192e-22, 1.7827297167437681e-22, 2.0796997203176947e-22, 2.3766265855686034e-22, 2.6735103798686366e-22, 2.9703511704503075e-22, 3.267149024406825e-22, 3.563904008692425e-22, 3.860616190122697e-22, 4.1572856353749102e-22, 4.453912410988343e-22, 4.750496583364603e-22, 5.047038218767956e-22, 5.343537383325649e-22, 5.639994143028233e-22, 5.936408563729884e-22, 6.232780711148727e-22, 6.529110650867158e-22, 6.825398448332162e-22, 7.12164416885563e-22, 7.417847877614686e-22, 7.714009639651998e-22, 8.010129519876098e-22, 8.306207583061698e-22, 8.602243893850009e-22, 8.898238516749048e-22, 9.194191516133963e-22, 9.490102956247346e-22, 9.78597290119953e-22, 1.0081801414968926e-21, 1.0377588561402319e-21, 1.0673334404215176e-21, 1.0969039006991972e-21, 1.1264702433186484e-21, 1.1560324746122107e-21, 1.1855906008992162e-21, 1.2151446284860203e-21, 1.2446945636660323e-21, 1.274240412719746e-21, 1.30378218191477e-21, 1.3333198775058588e-21, 1.3628535057349427e-21, 1.3923830728311582e-21, 1.4219085850108782e-21, 1.4514300484777422e-21, 1.4809474694226865e-21, 1.5104608540239743e-21, 1.5399702084472256e-21, 1.5694755388454465e-21, 1.5989768513590604e-21, 1.6284741521159361e-21, 1.6579674472314191e-21, 1.6874567428083597e-21, 1.7169420449371433e-21, 1.746423359695721e-21, 1.7759006931496367e-21, 1.8053740513520577e-21, 1.834843440343804e-21, 1.864308866153378e-21, 1.893770334796992e-21, 1.9232278522785995e-21, 1.9526814245899214e-21, 1.982131057710478e-21, 2.0115767576076153e-21, 2.0410185302365353e-21, 2.0704563815403244e-21, 2.099890317449982e-21, 2.1293203438844483e-21, 2.158746466750634e-21, 2.188168691943449e-21, 2.2175870253458285e-21, 2.247001472828764e-21, 2.2764120402513303e-21, 2.3058187334607136e-21, 2.3352215582922398e-21, 2.364620520569403e-21, 2.394015626103892e-21, 2.4234068806956206e-21, 2.4527942901327532e-21, 2.482177860191733e-21, 2.511557596637312e-21, 2.540933505222575e-21, 2.5703055916889704e-21, 2.5996738617663354e-21, 2.6290383211729242e-21, 2.6583989756154364e-21, 2.6877558307890433e-21, 2.7171088923774146e-21, 2.7464581660527477e-21, 2.7758036574757915e-21, 2.8051453722958768e-21, 2.834483316150941e-21, 2.8638174946675568e-21, 2.8931479134609577e-21, 2.9224745781350646e-21, 2.9517974942825146e-21], "losses": []}}, "proton": {"theory": {"positions": [[8.9113923229424e-12, 0.0], [8.911392422116547e-12, -0.00021790681520349328], [8.911392719638992e-12, -0.00043581362070671916], [8.911393215509725e-12, -0.0006537204068094126], [8.911393909728736e-12, -0.0008716271638113129], [8.91139480229601e-12, -0.0010895338820121653], [8.911395893211532e-12, -0.0013074405517117243], [8.911397182475276e-12, -0.0015253471632097546], [8.911398670087215e-12, -0.0017432537068060338], [8.91140035604732e-12, -0.0019611601728003547], [8.911402240355555e-12, -0.0021790665514925278], [8.911404323011881e-12, -0.0023969728331823814], [8.911406604016255e-12, -0.002614879008169767], [8.911409083368631e-12, -0.0028327850667545585], [8.911411761068955e-12, -0.0030506909992366557], [8.911414637117173e-12, -0.0032685967959159867], [8.911417711513226e-12, -0.003486502447092509], [8.911420984257046e-12, -0.0037044079430662135], [8.91142445534857e-12, -0.003922313274137124], [8.911428124787726e-12, -0.004140218430605301], [8.911431992574433e-12, -0.004358123402770844], [8.911436058708614e-12, -0.004576028180933894], [8.911440323190184e-12, -0.004793932755394633], [8.911444786019055e-12, -0.00501183711645329], [8.911449447195132e-12, -0.005229741254410139], [8.911454306718321e-12, -0.005447645159565507], [8.91145936458852e-12, -0.005665548822219767], [8.911464620805624e-12, -0.005883452232673352], [8.911470075369521e-12, -0.006101355381226745], [8.911475728280102e-12, -0.0063192582581804895], [8.911481579537247e-12, -0.00653716085383519], [8.911487629140835e-12, -0.006755063158491512], [8.911493877090741e-12, -0.006972965162450185], [8.911500323386834e-12, -0.007190866856012005], [8.91150696802898e-12, -0.007408768229477837], [8.911513811017042e-12, -0.007626669273148618], [8.911520852350877e-12, -0.007844569977325357], [8.911528092030339e-12, -0.008062470332309135], [8.911535530055279e-12, -0.008280370328401116], [8.911543166425539e-12, -0.008498269955902539], [8.911551001140963e-12, -0.008716169205114725], [8.911559034201388e-12, -0.008934068066339082], [8.911567265606646e-12, -0.009151966529877098], [8.911575695356568e-12, -0.009369864586030355], [8.911584323450977e-12, -0.009587762225100521], [8.911593149889698e-12, -0.009805659437389357], [8.911602174672541e-12, -0.010023556213198719], [8.911611397799324e-12, -0.01024145254283056], [8.911620819269853e-12, -0.01045934841658693], [8.911630439083932e-12, -0.010677243824769981], [8.911640257241362e-12, -0.010895138757681968], [8.911650273741938e-12, -0.011113033205625249], [8.91166048858545e-12, -0.011330927158902293], [8.911670901771691e-12, -0.011548820607815676], [8.911681513300442e-12, -0.011766713542668084], [8.911692323171483e-12, -0.01198460595376232], [8.911703331384589e-12, -0.0122024978314013], [8.911714537939531e-12, -0.012420389165888059], [8.911725942836079e-12, -0.012638279947525753], [8.911737546073994e-12, -0.012856170166617659], [8.911749347653035e-12, -0.01307405981346718], [8.911761347572956e-12, -0.013291948878377842], [8.911773545833508e-12, -0.013509837351653302], [8.911785942434438e-12, -0.013727725223597349], [8.91179853737549e-12, -0.013945612484513903], [8.911811330656398e-12, -0.014163499124707019], [8.911824322276899e-12, -0.014381385134480892], [8.911837512236724e-12, -0.014599270504139852], [8.9118509005356e-12, -0.014817155223988373], [8.911864487173245e-12, -0.015035039284331073], [8.91187827214938e-12, -0.015252922675472715], [8.911892255463717e-12, -0.015470805387718209], [8.911906437115966e-12, -0.015688687411372616], [8.91192081710583e-12, -0.015906568736741154], [8.911935395433014e-12, -0.016124449354129183], [8.911950172097214e-12, -0.016342329253842235], [8.911965147098123e-12, -0.016560208426185986], [8.911980320435428e-12, -0.016778086861466285], [8.911995692108816e-12, -0.016995964549989133], [8.912011262117967e-12, -0.017213841482060708], [8.912027030462558e-12, -0.017431717647987344], [8.91204299714226e-12, -0.01764959303807555], [8.912059162156743e-12, -0.017867467642632008], [8.912075525505669e-12, -0.01808534145196357], [8.912092087188702e-12, -0.01830321445637726], [8.912108847205494e-12, -0.018521086646180292], [8.9121258055557e-12, -0.01873895801168005], [8.912142962238965e-12, -0.0189568285431841], [8.912160317254936e-12, -0.0191746982310002], [8.91217787060325e-12, -0.019392567065436288], [8.912195622283544e-12, -0.019610435036800492], [8.912213572295448e-12, -0.019828302135401134], [8.91223172063859e-12, -0.020046168351546722], [8.912250067312593e-12, -0.020264033675545967], [8.912268612317072e-12, -0.02048189809770777], [8.912287355651649e-12, -0.020699761608341236], [8.912306297315928e-12, -0.02091762419775567], [8.912325437309519e-12, -0.02113548585626058], [8.912344775632023e-12, -0.021353346574165682], [8.912364312283039e-12, -0.021571206341780898], [8.91238404726216e-12, -0.02178906514941636]], "velocities": [], "times": [0.0, 2.8047639271704553e-23, 5.609527841855317e-23, 8.414291731568994e-23, 1.12190555838259e-22, 1.402381938614045e-22, 1.6828583126027076e-22, 1.963334679100022e-22, 2.2438110368574337e-22, 2.524287384626389e-22, 2.804763721158337e-22, 3.085240045204728e-22, 3.3657163555170163e-22, 3.6461926508466564e-22, 3.9266689299451067e-22, 4.2071451915638285e-22, 4.487621434454286e-22, 4.768097657367947e-22, 5.048573859056283e-22, 5.329050038270769e-22, 5.609526193762885e-22, 5.890002324284114e-22, 6.170478428585943e-22, 6.450954505419866e-22, 6.73143055353738e-22, 7.011906571689989e-22, 7.292382558629203e-22, 7.572858513106532e-22, 7.8533344338735e-22, 8.133810319681629e-22, 8.414286169282456e-22, 8.694761981427515e-22, 8.975237754868356e-22, 9.25571348835653e-22, 9.536189180643595e-22, 9.81666483048112e-22, 1.0097140436620682e-21, 1.037761599781386e-21, 1.065809151281225e-21, 1.0938566980367448e-21, 1.1219042399231063e-21, 1.1499517768154714e-21, 1.1779993085890024e-21, 1.2060468351188629e-21, 1.2340943562802172e-21, 1.2621418719482312e-21, 1.2901893819980709e-21, 1.318236886304904e-21, 1.3462843847438987e-21, 1.374331877190225e-21, 1.4023793635190532e-21, 1.430426843605555e-21, 1.4584743173249038e-21, 1.4865217845522731e-21, 1.5145692451628383e-21, 1.5426166990317757e-21, 1.570664146034263e-21, 1.598711586045479e-21, 1.626759018940604e-21, 1.6548064445948192e-21, 1.6828538628833077e-21, 1.710901273681253e-21, 1.738948676863841e-21, 1.7669960723062583e-21, 1.795043459883693e-21, 1.823090839471335e-21, 1.851138210944375e-21, 1.879185574178006e-21, 1.9072329290474217e-21, 1.9352802754278176e-21, 1.963327613194391e-21, 1.9913749422223406e-21, 2.019422262386866e-21, 2.0474695735631697e-21, 2.075516875626455e-21, 2.103564168451927e-21, 2.131611451914792e-21, 2.1596587258902594e-21, 2.1877059902535384e-21, 2.2157532448798414e-21, 2.243800489644382e-21, 2.271847724422376e-21, 2.29989494908904e-21, 2.3279421635195938e-21, 2.355989367589258e-21, 2.3840365611732556e-21, 2.412083744146811e-21, 2.4401309163851515e-21, 2.4681780777635046e-21, 2.496225228157102e-21, 2.524272367441176e-21, 2.5523194954909605e-21, 2.5803666121816922e-21, 2.6084137173886107e-21, 2.6364608109869557e-21, 2.6645078928519704e-21, 2.6925549628589002e-21, 2.720602020882991e-21, 2.7486490667994934e-21, 2.7766961004836583e-21, 2.804743121810739e-21], "losses": []}}};
        const THEORY_NAME = 'Schwarzschild';
        const BLACK_HOLE_MASS = 99450000000000.0;
        
        // Particle colors
        const PARTICLE_COLORS = {
            electron: { 
                theory: [0.29, 0.62, 1.0, 1.0],  // Blue
                kerr: [0.29, 0.62, 1.0, 0.5]      // Blue (transparent)
            },
            neutrino: { 
                theory: [0.96, 0.26, 0.21, 1.0],  // Red
                kerr: [0.96, 0.26, 0.21, 0.5]     // Red (transparent)
            },
            photon: { 
                theory: [0.98, 0.74, 0.02, 1.0],  // Yellow
                kerr: [0.98, 0.74, 0.02, 0.5]     // Yellow (transparent)
            },
            proton: { 
                theory: [0.18, 0.80, 0.44, 1.0],  // Green
                kerr: [0.18, 0.80, 0.44, 0.5]     // Green (transparent)
            }
        };
        
        // Track which particles are enabled
        const particleEnabled = {};
        
        // WebGL setup
        const canvas = document.getElementById('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        
        if (!gl) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').innerHTML = 'WebGL not supported in your browser.';
            document.getElementById('error').style.display = 'block';
        }
        
        // Resize canvas
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            gl.viewport(0, 0, canvas.width, canvas.height);
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // Shader sources
        const vertexShaderSource = `
            attribute vec2 a_position;
            uniform mat3 u_matrix;
            uniform float u_pointSize;
            
            void main() {
                vec3 position = u_matrix * vec3(a_position, 1.0);
                gl_Position = vec4(position.xy, 0.0, 1.0);
                gl_PointSize = u_pointSize;
            }
        `;
        
        const fragmentShaderSource = `
            precision mediump float;
            uniform vec4 u_color;
            uniform float u_isPoint;
            
            void main() {
                if (u_isPoint > 0.5) {
                    // Draw circular point
                    vec2 coord = gl_PointCoord - vec2(0.5);
                    if (length(coord) > 0.5) {
                        discard;
                    }
                }
                gl_FragColor = u_color;
            }
        `;
        
        // Create shaders
        function createShader(gl, type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                console.error('Shader compilation error:', gl.getShaderInfoLog(shader));
                gl.deleteShader(shader);
                return null;
            }
            return shader;
        }
        
        const vertexShader = createShader(gl, gl.VERTEX_SHADER, vertexShaderSource);
        const fragmentShader = createShader(gl, gl.FRAGMENT_SHADER, fragmentShaderSource);
        
        // Create program
        const program = gl.createProgram();
        gl.attachShader(program, vertexShader);
        gl.attachShader(program, fragmentShader);
        gl.linkProgram(program);
        
        if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
            console.error('Program linking error:', gl.getProgramInfoLog(program));
        }
        
        // Get locations
        const positionLocation = gl.getAttribLocation(program, 'a_position');
        const matrixLocation = gl.getUniformLocation(program, 'u_matrix');
        const colorLocation = gl.getUniformLocation(program, 'u_color');
        const pointSizeLocation = gl.getUniformLocation(program, 'u_pointSize');
        const isPointLocation = gl.getUniformLocation(program, 'u_isPoint');
        
        // Create buffer
        const positionBuffer = gl.createBuffer();
        
        // Animation state
        let currentStep = 0;
        let isPlaying = true;
        let showTrail = true;
        let showGrid = true;
        let cameraX = 0;
        let cameraY = 0;
        let cameraZoom = 1;
        let animationSpeed = 3;
        
        // Calculate bounds from all particle data
        function calculateBounds() {
            let minX = Infinity, maxX = -Infinity;
            let minY = Infinity, maxY = -Infinity;
            
            if (PARTICLE_DATA) {
                Object.keys(PARTICLE_DATA).forEach(particleName => {
                    const particleData = PARTICLE_DATA[particleName];
                    ['theory', 'kerr'].forEach(dataType => {
                        const data = particleData[dataType];
                        if (data && data.positions) {
                            data.positions.forEach(pos => {
                                const x = pos[0] * Math.cos(pos[1]);
                                const y = pos[0] * Math.sin(pos[1]);
                                minX = Math.min(minX, x);
                                maxX = Math.max(maxX, x);
                                minY = Math.min(minY, y);
                                maxY = Math.max(maxY, y);
                            });
                        }
                    });
                });
            }
            
            const scale = Math.max(maxX - minX, maxY - minY) * 1.2;
            return { minX, maxX, minY, maxY, scale: scale || 100 };
        }
        
        // Matrix operations
        function createMatrix(tx, ty, scale) {
            const aspect = canvas.width / canvas.height;
            return [
                2 * scale / canvas.width, 0, 0,
                0, -2 * scale / canvas.height, 0,
                tx, ty, 1
            ];
        }
        
        // Draw scene
        function drawScene() {
            gl.clearColor(0.04, 0.04, 0.04, 1.0);
            gl.clear(gl.COLOR_BUFFER_BIT);
            
            gl.useProgram(program);
            
            const bounds = calculateBounds();
            const matrix = createMatrix(
                -cameraX / bounds.scale,
                -cameraY / bounds.scale,
                cameraZoom / bounds.scale
            );
            gl.uniformMatrix3fv(matrixLocation, false, matrix);
            
            // Draw grid
            if (showGrid) {
                drawGrid();
            }
            
            // Draw black hole
            drawBlackHole();
            
            // Draw all particle trajectories
            if (PARTICLE_DATA) {
                Object.keys(PARTICLE_DATA).forEach(particleName => {
                    if (particleEnabled[particleName]) {
                        const particleData = PARTICLE_DATA[particleName];
                        const colors = PARTICLE_COLORS[particleName];
                        
                        // Draw Kerr baseline (dashed)
                        if (particleData.kerr && particleData.kerr.positions) {
                            drawTrajectory(particleData.kerr, colors.kerr, currentStep, true);
                        }
                        
                        // Draw theory trajectory (solid)
                        if (particleData.theory && particleData.theory.positions) {
                            drawTrajectory(particleData.theory, colors.theory, currentStep, false);
                        }
                        
                        // Draw current positions
                        if (particleData.theory && particleData.theory.positions && 
                            currentStep < particleData.theory.positions.length) {
                            drawParticle(particleData.theory.positions[currentStep], colors.theory);
                        }
                        if (particleData.kerr && particleData.kerr.positions && 
                            currentStep < particleData.kerr.positions.length) {
                            drawParticle(particleData.kerr.positions[currentStep], colors.kerr);
                        }
                    }
                });
            }
        }
        
        function drawGrid() {
            const gridSize = 10;
            const gridLines = [];
            
            for (let i = -100; i <= 100; i += gridSize) {
                // Vertical lines
                gridLines.push(i, -100, i, 100);
                // Horizontal lines
                gridLines.push(-100, i, 100, i);
            }
            
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(gridLines), gl.STATIC_DRAW);
            gl.enableVertexAttribArray(positionLocation);
            gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
            
            gl.uniform4f(colorLocation, 0.2, 0.2, 0.2, 0.3);
            gl.uniform1f(isPointLocation, 0.0);
            
            for (let i = 0; i < gridLines.length / 4; i++) {
                gl.drawArrays(gl.LINES, i * 2, 2);
            }
        }
        
        function drawBlackHole() {
            const segments = 64;
            const vertices = [];
            
            // Event horizon (r = 2M)
            const r_horizon = 2;
            for (let i = 0; i <= segments; i++) {
                const angle = (i / segments) * Math.PI * 2;
                vertices.push(r_horizon * Math.cos(angle), r_horizon * Math.sin(angle));
            }
            
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
            gl.enableVertexAttribArray(positionLocation);
            gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
            
            gl.uniform4f(colorLocation, 1.0, 1.0, 1.0, 0.5);
            gl.uniform1f(isPointLocation, 0.0);
            gl.drawArrays(gl.LINE_LOOP, 0, vertices.length / 2);
        }
        
        function drawTrajectory(data, color, upToStep, isDashed) {
            if (!data.positions || data.positions.length === 0) return;
            
            const vertices = [];
            const limit = showTrail ? upToStep : Math.max(0, upToStep - 50);
            
            for (let i = Math.max(0, limit); i <= upToStep && i < data.positions.length; i++) {
                const pos = data.positions[i];
                const x = pos[0] * Math.cos(pos[1]);
                const y = pos[0] * Math.sin(pos[1]);
                vertices.push(x, y);
            }
            
            if (vertices.length > 2) {
                gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
                gl.enableVertexAttribArray(positionLocation);
                gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
                
                const alpha = showTrail ? color[3] : color[3] * 0.5;
                gl.uniform4f(colorLocation, color[0], color[1], color[2], alpha);
                gl.uniform1f(isPointLocation, 0.0);
                
                if (isDashed) {
                    // Draw dashed line for Kerr baseline
                    for (let i = 0; i < vertices.length / 2 - 1; i += 2) {
                        gl.drawArrays(gl.LINES, i, 2);
                    }
                } else {
                    gl.drawArrays(gl.LINE_STRIP, 0, vertices.length / 2);
                }
            }
        }
        
        function drawParticle(position, color) {
            const x = position[0] * Math.cos(position[1]);
            const y = position[0] * Math.sin(position[1]);
            
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([x, y]), gl.STATIC_DRAW);
            gl.enableVertexAttribArray(positionLocation);
            gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
            
            gl.uniform4f(colorLocation, color[0], color[1], color[2], color[3]);
            gl.uniform1f(pointSizeLocation, 8.0);
            gl.uniform1f(isPointLocation, 1.0);
            gl.drawArrays(gl.POINTS, 0, 1);
        }
        
        // Update info panel
        function updateInfo() {
            let maxSteps = 0;
            let currentTime = 0;
            
            if (PARTICLE_DATA) {
                Object.keys(PARTICLE_DATA).forEach(particleName => {
                    const particleData = PARTICLE_DATA[particleName];
                    if (particleData.theory && particleData.theory.positions) {
                        maxSteps = Math.max(maxSteps, particleData.theory.positions.length);
                        if (particleData.theory.times && currentStep < particleData.theory.times.length) {
                            currentTime = Math.max(currentTime, particleData.theory.times[currentStep]);
                        }
                    }
                });
            }
            
            document.getElementById('stepInfo').textContent = `${currentStep} / ${maxSteps}`;
            document.getElementById('timeInfo').textContent = currentTime.toExponential(2);
        }
        
        // Setup particle legend
        function setupParticleLegend() {
            const legend = document.getElementById('particleLegend');
            
            if (PARTICLE_DATA) {
                Object.keys(PARTICLE_DATA).forEach(particleName => {
                    const colors = PARTICLE_COLORS[particleName];
                    particleEnabled[particleName] = true; // Enable all by default
                    
                    const item = document.createElement('div');
                    item.className = 'particle-item';
                    item.innerHTML = `
                        <div class="color-box" style="background: rgb(${Math.round(colors.theory[0]*255)}, ${Math.round(colors.theory[1]*255)}, ${Math.round(colors.theory[2]*255)})"></div>
                        <div>${particleName}</div>
                    `;
                    
                    item.onclick = () => {
                        particleEnabled[particleName] = !particleEnabled[particleName];
                        item.classList.toggle('disabled', !particleEnabled[particleName]);
                    };
                    
                    legend.appendChild(item);
                });
            }
        }
        
        // Animation loop
        function animate() {
            if (isPlaying) {
                currentStep += animationSpeed;
                
                // Find max steps across all particles
                let maxSteps = 0;
                if (PARTICLE_DATA) {
                    Object.values(PARTICLE_DATA).forEach(particleData => {
                        if (particleData.theory && particleData.theory.positions) {
                            maxSteps = Math.max(maxSteps, particleData.theory.positions.length);
                        }
                    });
                }
                
                if (currentStep >= maxSteps - 1) {
                    currentStep = maxSteps - 1;
                    isPlaying = false;
                    document.getElementById('playPause').textContent = 'Play';
                }
            }
            
            drawScene();
            updateInfo();
            requestAnimationFrame(animate);
        }
        
        // Controls
        document.getElementById('playPause').addEventListener('click', () => {
            isPlaying = !isPlaying;
            document.getElementById('playPause').textContent = isPlaying ? 'Pause' : 'Play';
        });
        
        document.getElementById('reset').addEventListener('click', () => {
            currentStep = 0;
            isPlaying = false;
            document.getElementById('playPause').textContent = 'Play';
        });
        
        document.getElementById('speed').addEventListener('input', (e) => {
            animationSpeed = parseFloat(e.target.value);
        });
        
        document.getElementById('zoom').addEventListener('input', (e) => {
            cameraZoom = parseFloat(e.target.value);
        });
        
        document.getElementById('toggleTrail').addEventListener('click', (e) => {
            showTrail = !showTrail;
            e.target.classList.toggle('active', showTrail);
        });
        
        document.getElementById('toggleGrid').addEventListener('click', (e) => {
            showGrid = !showGrid;
            e.target.classList.toggle('active', showGrid);
        });
        
        // Mouse controls
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        
        canvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const dx = e.clientX - lastMouseX;
                const dy = e.clientY - lastMouseY;
                cameraX += dx * 2;
                cameraY += dy * 2;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
            }
        });
        
        canvas.addEventListener('mouseup', () => {
            isDragging = false;
        });
        
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const scaleFactor = e.deltaY > 0 ? 0.9 : 1.1;
            cameraZoom *= scaleFactor;
            cameraZoom = Math.max(0.1, Math.min(10, cameraZoom));
            document.getElementById('zoom').value = cameraZoom;
        });
        
        // Initialize
        document.getElementById('loading').style.display = 'none';
        document.getElementById('toggleTrail').classList.add('active');
        document.getElementById('toggleGrid').classList.add('active');
        setupParticleLegend();
        animate();
    </script>
</body>
</html>