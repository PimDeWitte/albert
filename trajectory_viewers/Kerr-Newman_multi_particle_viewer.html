<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerr-Newman - Multi-Particle Trajectory Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0a0a0a;
            color: #fff;
            overflow: hidden;
        }
        
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            max-width: 300px;
        }
        
        h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        
        .button {
            background: #2980b9;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 2px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .button:hover {
            background: #3498db;
        }
        
        .button.active {
            background: #27ae60;
        }
        
        input[type="range"] {
            width: 200px;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
        }
        
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #e74c3c;
            display: none;
        }
        
        .particle-legend {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .particle-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            cursor: pointer;
        }
        
        .particle-item:hover {
            opacity: 0.8;
        }
        
        .particle-item.disabled {
            opacity: 0.3;
        }
        
        .color-box {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
        }
        
        .stats {
            font-size: 12px;
            color: #999;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div id="loading">Loading trajectories...</div>
    <div id="error"></div>
    
    <div class="controls">
        <h3>Controls</h3>
        <div>
            <button class="button" id="playPause">Play</button>
            <button class="button" id="reset">Reset</button>
        </div>
        <div style="margin-top: 10px;">
            <label>Speed: <input type="range" id="speed" min="0" max="10" value="3" step="0.1"></label>
        </div>
        <div style="margin-top: 10px;">
            <label>Zoom: <input type="range" id="zoom" min="0.1" max="10" value="1" step="0.1"></label>
        </div>
        <div style="margin-top: 10px;">
            <button class="button" id="toggleTrail">Show Trail</button>
            <button class="button" id="toggleGrid">Show Grid</button>
        </div>
    </div>
    
    <div class="info">
        <h3>Kerr-Newman</h3>
        <div>Black Hole Mass: 99450000000000.0 kg</div>
        <div>Step: <span id="stepInfo">0 / 0</span></div>
        <div>Time: <span id="timeInfo">0.00e+00</span> s</div>
        
        <div class="particle-legend" id="particleLegend">
            <h4>Particles (click to toggle)</h4>
        </div>
        
        <div class="stats" id="stats"></div>
    </div>

    <script>
        // Multi-particle trajectory data will be injected here
        const PARTICLE_DATA = {"electron": {"theory": {"positions": [[8.9113923229424e-12, 0.0], [8.911392323301375e-12, -2.5995757631267088e-05], [8.911392324525481e-12, -5.459109102074801e-05], [8.91139232687537e-12, -8.60459577368852e-05], [8.91139233067433e-12, -0.00012064631110131476], [8.911392336322223e-12, -0.0001587066997627239], [8.911392344312442e-12, -0.00020057312722755673], [8.911392355252502e-12, -0.00024662619734306453], [8.91139236988906e-12, -0.000297284574327681], [8.911392389138284e-12, -0.00035300878880311384], [8.911392414122738e-12, -0.0004143054244278678], [8.911392446216107e-12, -0.0004817317231917295], [8.91139248709748e-12, -0.0005559006512364899], [8.911392538817184e-12, -0.0006374864712544303], [8.911392603876586e-12, -0.0007272308721208804], [8.911392685324883e-12, -0.0008259497114822906], [8.911392786876381e-12, -0.000934540432592746], [8.911392913052662e-12, -0.0010539902228202612], [8.911393069354825e-12, -0.0011853849879851503], [8.911393262472196e-12, -0.0013299192241074272], [8.91139350053514e-12, -0.0014889068762957978], [8.911393793421324e-12, -0.0016637932834812667], [8.911394153126633e-12, -0.0018561683175649694], [8.911394594214387e-12, -0.0020677808364018397], [8.911395134359338e-12, -0.002300554581977281], [8.91139579500638e-12, -0.002556605668260916], [8.911396536987975e-12, -0.0028165630245830906], [8.911397350764742e-12, -0.0030765203363058305], [8.91139823633669e-12, -0.0033364775993127978], [8.911399193703829e-12, -0.0035964348094876565], [8.911400222866169e-12, -0.003856391962714074], [8.911401323823725e-12, -0.004116349054875721], [8.911402496576511e-12, -0.004376306081856273], [8.91140374112454e-12, -0.004636263039539406], [8.91140505746783e-12, -0.004896219923808805], [8.911406445606394e-12, -0.005156176730548155], [8.91140790554025e-12, -0.005416133455641147], [8.911409437269418e-12, -0.005676090094971478], [8.911411040793914e-12, -0.005936046644422847], [8.91141271611376e-12, -0.006196003099878962], [8.911414463228976e-12, -0.006455959457223535], [8.911416282139584e-12, -0.006715915712340282], [8.911418172845605e-12, -0.006975871861112926], [8.911420135347063e-12, -0.0072358278994251995], [8.911422169643982e-12, -0.007495783823160837], [8.911424275736388e-12, -0.007755739628203581], [8.911426453624307e-12, -0.008015695310437183], [8.911428703307765e-12, -0.008275650865745398], [8.911431024786792e-12, -0.008535606290011993], [8.911433418061414e-12, -0.008795561579120738], [8.911435883131664e-12, -0.009055516728955415], [8.91143841999757e-12, -0.009315471735399811], [8.911441028659162e-12, -0.009575426594337723], [8.911443709116473e-12, -0.009835381301652957], [8.911446461369537e-12, -0.010095335853229326], [8.911449285418387e-12, -0.010355290244950655], [8.91145218126306e-12, -0.010615244472700775], [8.911455148903588e-12, -0.01087519853236353], [8.911458188340009e-12, -0.011135152419822773], [8.91146129957236e-12, -0.011395106130962365], [8.911464482600683e-12, -0.011655059661666179], [8.911467737425015e-12, -0.011915013007818099], [8.911471064045392e-12, -0.01217496616530202], [8.91147446246186e-12, -0.012434919130001845], [8.91147793267446e-12, -0.012694871897801493], [8.911481474683233e-12, -0.01295482446458489], [8.911485088488224e-12, -0.013214776826235978], [8.911488774089478e-12, -0.013474728978638708], [8.911492531487042e-12, -0.013734680917677045], [8.91149636068096e-12, -0.013994632639234963], [8.911500261671278e-12, -0.014254584139196455], [8.911504234458048e-12, -0.014514535413445523], [8.911508279041316e-12, -0.014774486457866182], [8.911512395421132e-12, -0.015034437268342462], [8.91151658359755e-12, -0.015294387840758405], [8.911520843570618e-12, -0.015554338170998069], [8.911525175340392e-12, -0.015814288254945526], [8.911529578906924e-12, -0.01607423808848486], [8.911534054270268e-12, -0.01633418766750017], [8.91153860143048e-12, -0.016594136987875575], [8.911543220387616e-12, -0.016854086045495202], [8.911547911141732e-12, -0.0171140348362432], [8.911552673692885e-12, -0.01737398335600373], [8.911557508041136e-12, -0.017633931600660964], [8.911562414186545e-12, -0.017893879566099103], [8.91156739212917e-12, -0.018153827248202352], [8.911572441869073e-12, -0.01841377464285494], [8.911577563406317e-12, -0.01867372174594111], [8.911582756740967e-12, -0.018933668553345127], [8.911588021873082e-12, -0.019193615060951262], [8.911593358802732e-12, -0.01945356126464381], [8.91159876752998e-12, -0.019713507160307092], [8.911604248054895e-12, -0.019973452743825434], [8.911609800377542e-12, -0.020233398011083186], [8.911615424497993e-12, -0.02049334295796472], [8.911621120416317e-12, -0.020753287580354416], [8.91162688813258e-12, -0.021013231874136687], [8.911632727646858e-12, -0.021273175835195956], [8.911638638959219e-12, -0.021533119459416668], [8.911644622069735e-12, -0.02179306274268329]], "velocities": [], "times": [0.0, 2.8592272830194145e-24, 6.004377294285237e-24, 9.464042306538694e-24, 1.3269673819753872e-23, 1.7455868483844474e-23, 2.2060682613635177e-23, 2.7125978155321934e-23, 3.26978032495672e-23, 3.8826810850889777e-23, 4.5568719208973496e-23, 5.298481839807983e-23, 6.114252749936541e-23, 7.011600750138257e-23, 7.99868354905647e-23, 9.084474626067263e-23, 1.0278844808306839e-22, 1.1592652005385967e-22, 1.3037839917554892e-22, 1.4627546614656695e-22, 1.6376223972938519e-22, 1.829976905549386e-22, 2.0415668630682233e-22, 2.2743158142301584e-22, 2.5303396576658793e-22, 2.8119658816188374e-22, 3.097888585053025e-22, 3.383811283445686e-22, 3.6697339763315083e-22, 3.955656663245181e-22, 4.241579343721392e-22, 4.5275020172948325e-22, 4.8134246835001905e-22, 5.099347341872155e-22, 5.385269991945417e-22, 5.671192633254668e-22, 5.957115265334596e-22, 6.2430378877198945e-22, 6.528960499945255e-22, 6.81488310154537e-22, 7.100805692054932e-22, 7.386728271008633e-22, 7.67265083794117e-22, 7.958573392387234e-22, 8.244495933881521e-22, 8.530418461958726e-22, 8.816340976153547e-22, 9.10226347600068e-22, 9.388185961034821e-22, 9.674108430790672e-22, 9.960030884802927e-22, 1.0245953322606287e-21, 1.0531875743735454e-21, 1.0817798147725128e-21, 1.1103720534110012e-21, 1.1389642902424808e-21, 1.167556525220422e-21, 1.1961487582982949e-21, 1.2247409894295704e-21, 1.2533332185677193e-21, 1.281925445666212e-21, 1.3105176706785192e-21, 1.339109893558112e-21, 1.3677021142584615e-21, 1.3962943327330385e-21, 1.4248865489353148e-21, 1.4534787628187612e-21, 1.4820709743368494e-21, 1.5106631834430503e-21, 1.5392553900908363e-21, 1.567847594233679e-21, 1.59643979582505e-21, 1.6250319948184215e-21, 1.653624191167266e-21, 1.6822163848250549e-21, 1.7108085757452612e-21, 1.739400763881357e-21, 1.7679929491868152e-21, 1.7965851316151085e-21, 1.82517731111971e-21, 1.853769487654092e-21, 1.8823616611717284e-21, 1.910953831626092e-21, 1.9395459989706567e-21, 1.9681381631588956e-21, 1.996730324144283e-21, 2.0253224818802923e-21, 2.0539146363203976e-21, 2.0825067874180737e-21, 2.111098935126794e-21, 2.1396910794000336e-21, 2.1682832201912668e-21, 2.1968753574539687e-21, 2.2254674911416143e-21, 2.2540596212076784e-21, 2.282651747605637e-21, 2.311243870288965e-21, 2.339835989211138e-21, 2.3684281043256324e-21, 2.3970202155859235e-21], "losses": []}}, "neutrino": {"theory": {"positions": [[8.9113923229424e-12, -0.028867513459481287], [8.911370884959686e-12, -2.516611137727853e-05], [8.91134730201316e-12, -5.284897169484119e-05], [8.911321359361652e-12, -8.330028479521767e-05], [8.911292820738479e-12, -0.00011679693098767466], [8.911261426188075e-12, -0.00015364348597330315], [8.911226889684048e-12, -0.00019417499193144307], [8.911188896506278e-12, -0.00023876000604015248], [8.911147100352424e-12, -0.0002878039542426197], [8.911101120156536e-12, -0.00034175282086704287], [8.911050536584693e-12, -0.00040109720778573973], [8.910994888174303e-12, -0.0004663768001890076], [8.910933667080203e-12, -0.000538185279782465], [8.910866314386773e-12, -0.0006171757303285697], [8.91079221494081e-12, -0.0007040665849827509], [8.910710691655083e-12, -0.0007996481698652948], [8.91062099922694e-12, -0.0009047899038095815], [8.910522317210322e-12, -0.001020448220288424], [8.910413742372586e-12, -0.0011476752842017983], [8.91029428025992e-12, -0.0012876285835762512], [8.91016283588654e-12, -0.001441581484351008], [8.910018203453129e-12, -0.0016109348453885468], [8.909859054989115e-12, -0.0017972298007374828], [8.909683927801043e-12, -0.002002161827092423], [8.909491210595445e-12, -0.002227596226449876], [8.909279128128856e-12, -0.0024755851672750356], [8.909063709877448e-12, -0.0027273693262575165], [8.908848190597337e-12, -0.002979165485652759], [8.908632570277693e-12, -0.0032309736519439856], [8.908416848907689e-12, -0.0034827938316163076], [8.908201026476486e-12, -0.0037346260311567265], [8.907985102973241e-12, -0.003986470257054134], [8.907769078387106e-12, -0.004238326515799315], [8.907552952707227e-12, -0.0044901948138849485], [8.90733672592274e-12, -0.004742075157805608], [8.90712039802278e-12, -0.004993967554057763], [8.906903968996472e-12, -0.005245872009139782], [8.906687438832936e-12, -0.005497788529551931], [8.90647080752129e-12, -0.005749717121796377], [8.906254075050639e-12, -0.0060016577923771896], [8.906037241410085e-12, -0.0062536105478003395], [8.905820306588725e-12, -0.006505575394573704], [8.905603270575649e-12, -0.006757552339207064], [8.905386133359941e-12, -0.007009541388212109], [8.905168894930676e-12, -0.007261542548102437], [8.90495155527693e-12, -0.007513555825393553], [8.904734114387762e-12, -0.007765581226602876], [8.904516572252239e-12, -0.008017618758249734], [8.904298928859409e-12, -0.008269668426855373], [8.90408118419832e-12, -0.00852173023894295], [8.903863338258015e-12, -0.008773804201037542], [8.903645391027526e-12, -0.009025890319666139], [8.903427342495883e-12, -0.009277988601357654], [8.903209192652109e-12, -0.009530099052642918], [8.90299094148522e-12, -0.009782221680054683], [8.902772588984225e-12, -0.010034356490127627], [8.902554135138129e-12, -0.01028650348939835], [8.90233557993593e-12, -0.010538662684405379], [8.90211692336662e-12, -0.010790834081689165], [8.901898165419183e-12, -0.01104301768779209], [8.9016793060826e-12, -0.011295213509258465], [8.901460345345842e-12, -0.011547421552634532], [8.90124128319788e-12, -0.011799641824468465], [8.901022119627671e-12, -0.012051874331310372], [8.900802854624177e-12, -0.012304119079712296], [8.900583488176339e-12, -0.012556376076228216], [8.900364020273103e-12, -0.012808645327414048], [8.900144450903406e-12, -0.013060926839827647], [8.899924780056176e-12, -0.01331322062002881], [8.89970500772034e-12, -0.013565526674579276], [8.899485133884812e-12, -0.013817845010042724], [8.899265158538506e-12, -0.01407017563298478], [8.899045081670326e-12, -0.014322518549973014], [8.898824903269174e-12, -0.014574873767576947], [8.89860462332394e-12, -0.014827241292368043], [8.898384241823511e-12, -0.015079621130919717], [8.89816375875677e-12, -0.01533201328980734], [8.897943174112588e-12, -0.015584417775608228], [8.897722487879835e-12, -0.015836834594901657], [8.897501700047376e-12, -0.016089263754268855], [8.897280810604062e-12, -0.01634170526029301], [8.897059819538745e-12, -0.016594159119559262], [8.89683872684027e-12, -0.016846625338654716], [8.896617532497472e-12, -0.017099103924168434], [8.896396236499185e-12, -0.017351594882691442], [8.896174838834228e-12, -0.017604098220816728], [8.895953339491425e-12, -0.017856613945139245], [8.895731738459586e-12, -0.018109142062255914], [8.89551003572752e-12, -0.01836168257876562], [8.895288231284023e-12, -0.01861423550126922], [8.895066325117892e-12, -0.01886680083636954], [8.894844317217914e-12, -0.019119378590671376], [8.894622207572868e-12, -0.019371968770781497], [8.894399996171533e-12, -0.01962457138330865], [8.894177683002675e-12, -0.019877186434863553], [8.893955268055057e-12, -0.020129813932058902], [8.893732751317438e-12, -0.020382453881509374], [8.893510132778563e-12, -0.020635106289831624], [8.89328741242718e-12, -0.02088777116364429], [8.893064590252025e-12, -0.021140448509567984]], "velocities": [], "times": [0.0, 2.2895202156762276e-24, 4.807993746812309e-24, 7.578316196763075e-24, 1.0625672786328978e-23, 1.397776732750382e-23, 1.76650740971212e-23, 2.1721114900920772e-23, 2.618276384771925e-23, 3.1090582605475226e-23, 3.64891891883799e-23, 4.242766362921784e-23, 4.895999422690712e-23, 5.614556842841106e-23, 6.40497128104865e-23, 7.274428707370866e-23, 8.230833745297608e-23, 9.282881548974901e-23, 1.044013687065638e-22, 1.1713121037934576e-22, 1.3113407632371866e-22, 1.4653727740449142e-22, 1.6348085735007527e-22, 1.8211886641376703e-22, 2.0262076248046773e-22, 2.2517295238022343e-22, 2.4806930979447846e-22, 2.7096577987156356e-22, 2.93862362670978e-22, 3.167590582522367e-22, 3.396558666748702e-22, 3.625527879984247e-22, 3.8544982228246216e-22, 4.083469695865602e-22, 4.31244229970312e-22, 4.541416034933266e-22, 4.770390902152287e-22, 4.999366901956587e-22, 5.228344034942728e-22, 5.457322301707427e-22, 5.686301702847564e-22, 5.91528223896017e-22, 6.144263910642438e-22, 6.373246718491718e-22, 6.602230663105519e-22, 6.831215745081505e-22, 7.060201965017502e-22, 7.289189323511491e-22, 7.518177821161615e-22, 7.74716745856617e-22, 7.976158236323617e-22, 8.205150155032572e-22, 8.434143215291811e-22, 8.663137417700269e-22, 8.892132762857038e-22, 9.121129251361373e-22, 9.350126883812684e-22, 9.579125660810546e-22, 9.808125582954688e-22, 1.0037126650845e-21, 1.0266128865081534e-21, 1.04951322262645e-21, 1.0724136734994266e-21, 1.0953142391871366e-21, 1.1182149197496488e-21, 1.1411157152470485e-21, 1.1640166257394365e-21, 1.1869176512869303e-21, 1.2098187919496627e-21, 1.2327200477877834e-21, 1.2556214188614573e-21, 1.2785229052308664e-21, 1.301424506956208e-21, 1.324326224097696e-21, 1.3472280567155596e-21, 1.3701300048700454e-21, 1.393032068621415e-21, 1.415934248029947e-21, 1.438836543155936e-21, 1.4617389540596921e-21, 1.4846414808015421e-21, 1.5075441234418292e-21, 1.5304468820409127e-21, 1.553349756659168e-21, 1.5762527473569865e-21, 1.5991558541947764e-21, 1.6220590772329615e-21, 1.6449624165319825e-21, 1.6678658721522963e-21, 1.6907694441543755e-21, 1.7136731325987095e-21, 1.736576937545804e-21, 1.759480859056181e-21, 1.7823848971903788e-21, 1.8052890520089516e-21, 1.8281933235724708e-21, 1.8510977119415236e-21, 1.8740022171767135e-21, 1.896906839338661e-21, 1.9198115784880027e-21], "losses": []}}, "photon": {"theory": {"positions": [[8.9113923229424e-12, 0.0], [8.9113923200064e-12, -3.965027520052983e-05], [8.911392309994645e-12, -8.326557798272129e-05], [8.911392290775303e-12, -0.00013124241119727474], [8.911392259704273e-12, -0.00018401692802573914], [8.911392213511135e-12, -0.0002420688970319311], [8.911392148160525e-12, -0.0003059260637252325], [8.911392058683686e-12, -0.00037616894828932485], [8.911391938973848e-12, -0.0004534361230960879], [8.911391781537791e-12, -0.0005384300179874531], [8.911391577194295e-12, -0.0006319233061077385], [8.911391314708208e-12, -0.0007347659283491944], [8.911390980346539e-12, -0.0008478928202823669], [8.911390557340053e-12, -0.000972332411833529], [8.911390025230446e-12, -0.0011092159770023026], [8.911389359078868e-12, -0.0012597879186481173], [8.911388528506592e-12, -0.0014254170818852982], [8.911387496532347e-12, -0.0016076091989916186], [8.911386218163492e-12, -0.0018080205790403832], [8.911384638689078e-12, -0.0020284731668067943], [8.911382691612012e-12, -0.0022709711079806688], [8.911380296144266e-12, -0.00253771897145577], [8.911377354173087e-12, -0.002831141794589685], [8.91137374658686e-12, -0.0031539071339797458], [8.911369328825749e-12, -0.003508949322637908], [8.911363925494012e-12, -0.003899496154646205], [8.911357856935554e-12, -0.004296001665409922], [8.911351201170382e-12, -0.004692507735471341], [8.91134395819715e-12, -0.005089014416453218], [8.911336128014393e-12, -0.0054855217599787875], [8.911327710620525e-12, -0.005882029817671809], [8.911318706013844e-12, -0.006278538641156602], [8.911309114192528e-12, -0.006675048282058088], [8.91129893515464e-12, -0.0070715587920018325], [8.911288168898116e-12, -0.0074680702226140845], [8.91127681542078e-12, -0.007864582625521817], [8.911264874720333e-12, -0.008261096052352769], [8.91125234679436e-12, -0.008657610554735483], [8.91123923164033e-12, -0.009054126184299351], [8.911225529255583e-12, -0.00945064299267465], [8.91121123963735e-12, -0.009847161031492585], [8.91119636278274e-12, -0.010243680352385329], [8.911180898688742e-12, -0.010640201006986065], [8.91116484735223e-12, -0.011036723046929021], [8.911148208769956e-12, -0.011433246523849522], [8.911130982938552e-12, -0.011829771489384017], [8.911113169854535e-12, -0.012226297995170131], [8.911094769514296e-12, -0.0126228260928467], [8.911075781914118e-12, -0.01301935583405381], [8.911056207050158e-12, -0.013415887270432846], [8.91103604491845e-12, -0.01381242045362652], [8.91101529551492e-12, -0.014208955435278926], [8.910993958835367e-12, -0.014605492267035567], [8.910972034875475e-12, -0.015002031000543403], [8.910949523630805e-12, -0.015398571687450895], [8.910926425096808e-12, -0.015795114379408035], [8.910902739268804e-12, -0.016191659128066402], [8.910878466142004e-12, -0.016588205985079183], [8.910853605711496e-12, -0.01698475500210123], [8.910828157972248e-12, -0.017381306230789095], [8.910802122919111e-12, -0.017777859722801072], [8.910775500546818e-12, -0.018174415529797233], [8.91074829084998e-12, -0.01857097370343947], [8.91072049382309e-12, -0.018967534295391546], [8.910692109460525e-12, -0.019364097357319122], [8.910663137756542e-12, -0.019760662940889802], [8.910633578705276e-12, -0.02015723109777318], [8.910603432300746e-12, -0.020553801879640867], [8.910572698536849e-12, -0.02095037533816655], [8.910541377407368e-12, -0.02134695152502602], [8.910509468905964e-12, -0.021743530491897207], [8.910476973026179e-12, -0.022140112290460243], [8.910443889761437e-12, -0.02253669697239748], [8.910410219105042e-12, -0.022933284589393546], [8.91037596105018e-12, -0.023329875193135376], [8.910341115589916e-12, -0.023726468835312254], [8.9103056827172e-12, -0.024123065567615863], [8.910269662424859e-12, -0.024519665441740314], [8.910233054705603e-12, -0.02491626850938219], [8.910195859552023e-12, -0.025312874822240594], [8.910158076956589e-12, -0.02570948443201718], [8.910119706911656e-12, -0.026106097390416198], [8.910080749409454e-12, -0.02650271374914454], [8.9100412044421e-12, -0.026899333559911764], [8.910001072001588e-12, -0.02729595687443016], [8.909960352079797e-12, -0.027692583744414773], [8.909919044668482e-12, -0.02808921422158344], [8.90987714975928e-12, -0.02848584835765685], [8.909834667343715e-12, -0.028882486204358564], [8.909791597413182e-12, -0.02927912781341507], [8.909747939958966e-12, -0.02967577323655582], [8.909703694972227e-12, -0.030072422525513266], [8.909658862444007e-12, -0.03046907573202291], [8.909613442365232e-12, -0.030865732907823337], [8.909567434726707e-12, -0.031262394104656255], [8.909520839519114e-12, -0.031659059374266545], [8.909473656733022e-12, -0.0320557287684023], [8.90942588635888e-12, -0.03245240233881484], [8.909377528387014e-12, -0.03284908013725881], [8.909328582807633e-12, -0.03324576221549216]], "velocities": [], "times": [0.0, 2.8659079991816747e-24, 6.018406798744597e-24, 9.48615547942242e-24, 1.330067903036626e-23, 1.7496654940124248e-23, 2.2112228446769664e-23, 2.7189359313110363e-23, 3.277420327951152e-23, 3.8917531662125113e-23, 4.5675192911110046e-23, 5.310862032489948e-23, 6.128539053619763e-23, 7.027983784698234e-23, 8.017372999755243e-23, 9.10570115132095e-23, 1.0302862138658485e-22, 1.1619739252950674e-22, 1.3068304117180312e-22, 1.4661725520232296e-22, 1.6414489134718425e-22, 1.8342529207002122e-22, 2.0463373416783033e-22, 2.2796302223384274e-22, 2.536252414766158e-22, 2.818536858342859e-22, 3.1051278656221112e-22, 3.3917189149407306e-22, 3.678310010178902e-22, 3.9649011552168425e-22, 4.251492353934802e-22, 4.53808361021307e-22, 4.824674927931973e-22, 5.111266310971882e-22, 5.397857763213213e-22, 5.684449288536426e-22, 5.971040890822037e-22, 6.257632573950612e-22, 6.544224341802773e-22, 6.8308161982592e-22, 7.117408147200636e-22, 7.404000192507885e-22, 7.69059233806182e-22, 7.977184587743382e-22, 8.263776945433584e-22, 8.550369415013515e-22, 8.836962000364336e-22, 9.123554705367294e-22, 9.410147533903718e-22, 9.696740489855017e-22, 9.983333577102693e-22, 1.0269926799528337e-21, 1.0556520161013632e-21, 1.084311366544036e-21, 1.1129707316690397e-21, 1.1416301118645725e-21, 1.1702895075188427e-21, 1.1989489190200694e-21, 1.2276083467564825e-21, 1.2562677911163235e-21, 1.2849272524878446e-21, 1.3135867312593104e-21, 1.3422462278189976e-21, 1.3709057425551943e-21, 1.3995652758562022e-21, 1.4282248281103351e-21, 1.4568843997059203e-21, 1.4855439910312984e-21, 1.5142036024748228e-21, 1.5428632344248623e-21, 1.5715228872697985e-21, 1.6001825613980281e-21, 1.6288422571979622e-21, 1.6575019750580271e-21, 1.6861617153666641e-21, 1.7148214785123303e-21, 1.7434812648834983e-21, 1.7721410748686566e-21, 1.8008009088563105e-21, 1.829460767234981e-21, 1.8581206503932075e-21, 1.8867805587195446e-21, 1.9154404926025654e-21, 1.9441004524308602e-21, 1.972760438593038e-21, 2.0014204514777247e-21, 2.0300804914735663e-21, 2.058740558969226e-21, 2.0874006543533862e-21, 2.1160607780147497e-21, 2.144720930342037e-21, 2.1733811117239907e-21, 2.2020413225493715e-21, 2.230701563206961e-21, 2.259361834085562e-21, 2.288022135573997e-21, 2.316682468061111e-21, 2.3453428319357694e-21, 2.3740032275868597e-21, 2.402663655403291e-21], "losses": []}}, "proton": {"theory": {"positions": [[8.9113923229424e-12, 0.0], [8.911392324183374e-12, -2.0157368913945206e-05], [8.911392328415096e-12, -4.233047470616893e-05], [8.911392336538641e-12, -6.672089104479921e-05], [8.911392349671603e-12, -9.355034895503097e-05], [8.911392369196312e-12, -0.0001230627525509295], [8.91139239681841e-12, -0.00015552639633898018], [8.911392434638077e-12, -0.00019123640425005418], [8.91139248523649e-12, -0.00023051741257195426], [8.911392551780846e-12, -0.00027372652117168867], [8.911392638151826e-12, -0.00032125653983522553], [8.911392749098246e-12, -0.000373539559234841], [8.911392890424707e-12, -0.00043105087898463046], [8.911393069219142e-12, -0.000494313328490068], [8.911393294128767e-12, -0.0005639020198670982], [8.91139357569461e-12, -0.0006404495761324719], [8.911393926756989e-12, -0.0007246518821854415], [8.911394362946949e-12, -0.0008172744108505948], [8.911394903281725e-12, -0.0009191591814754359], [8.911395570886213e-12, -0.0010312324143215033], [8.911396393866984e-12, -0.0011545129503060967], [8.911397406370981e-12, -0.0012901215125999555], [8.911398649867783e-12, -0.0014392908942268265], [8.911400174702546e-12, -0.0016033771642122256], [8.911402041976556e-12, -0.0017838719940657872], [8.911404325824384e-12, -0.0019824162165365286], [8.911406890844233e-12, -0.002183989318363097], [8.91140970405844e-12, -0.00238556230112198], [8.911412765466896e-12, -0.002587135153823847], [8.911416075069477e-12, -0.0027887078654794026], [8.911419632866059e-12, -0.0029902804250993924], [8.911423438856497e-12, -0.0031918528216946054], [8.911427493040643e-12, -0.003393425044275876], [8.911431795418338e-12, -0.0035949970818540894], [8.911436345989412e-12, -0.0037965689234401813], [8.911441144753684e-12, -0.003998140558045145], [8.911446191710966e-12, -0.00419971197468003], [8.91145148686106e-12, -0.004401283162355951], [8.911457030203758e-12, -0.004602854110084086], [8.911462821738839e-12, -0.00480442480687568], [8.911468861466077e-12, -0.00500599524174205], [8.911475149385233e-12, -0.005207565403694588], [8.91148168549606e-12, -0.005409135281744764], [8.911488469798301e-12, -0.005610704864904125], [8.911495502291691e-12, -0.005812274142184307], [8.91150278297595e-12, -0.006013843102597029], [8.911510311850793e-12, -0.0062154117351541], [8.911518088915922e-12, -0.006416980028867423], [8.911526114171032e-12, -0.006618547972748999], [8.911534387615806e-12, -0.006820115555810925], [8.911542909249918e-12, -0.007021682767065401], [8.911551679073034e-12, -0.007223249595524735], [8.911560697084806e-12, -0.0074248160302013404], [8.91156996328488e-12, -0.007626382060107744], [8.911579477672895e-12, -0.007827947674256588], [8.91158924024847e-12, -0.00802951286166063], [8.911599251011226e-12, -0.008231077611332753], [8.911609509960765e-12, -0.00843264191228596], [8.911620017096685e-12, -0.008634205753533384], [8.911630772418571e-12, -0.008835769124088287], [8.911641775926003e-12, -0.009037332012964064], [8.911653027618542e-12, -0.00923889440917425], [8.911664527495748e-12, -0.009440456301732514], [8.911676275557166e-12, -0.009642017679652674], [8.911688271802337e-12, -0.00984357853194869], [8.911700516230787e-12, -0.010045138847634673], [8.911713008842034e-12, -0.010246698615724886], [8.911725749635587e-12, -0.010448257825233747], [8.911738738610945e-12, -0.010649816465175831], [8.911751975767594e-12, -0.010851374524565879], [8.911765461105012e-12, -0.011052931992418791], [8.911779194622671e-12, -0.01125448885774964], [8.911793176320029e-12, -0.011456045109573666], [8.911807406196534e-12, -0.011657600736906285], [8.911821884251628e-12, -0.011859155728763091], [8.91183661048474e-12, -0.012060710074159856], [8.911851584895292e-12, -0.012262263762112537], [8.911866807482692e-12, -0.012463816781637277], [8.911882278246341e-12, -0.012665369121750408], [8.911897997185631e-12, -0.012866920771468456], [8.911913964299941e-12, -0.013068471719808142], [8.911930179588646e-12, -0.013270021955786386], [8.911946643051102e-12, -0.01347157146842031], [8.911963354686665e-12, -0.013673120246727241], [8.911980314494675e-12, -0.013874668279724719], [8.911997522474466e-12, -0.014076215556430486], [8.912014978625359e-12, -0.014277762065862508], [8.912032682946669e-12, -0.014479307797038961], [8.912050635437695e-12, -0.014680852738978248], [8.912068836097734e-12, -0.014882396880698992], [8.912087284926067e-12, -0.015083940211220044], [8.91210598192197e-12, -0.015285482719560485], [8.912124927084703e-12, -0.01548702439473963], [8.912144120413523e-12, -0.01568856522577703], [8.912163561907674e-12, -0.015890105201692473], [8.91218325156639e-12, -0.016091644311505997], [8.912203189388897e-12, -0.016293182544237873], [8.912223375374407e-12, -0.016494719888908636], [8.91224380952213e-12, -0.01669625633453906], [8.912264491831257e-12, -0.01689779187015018]], "velocities": [], "times": [0.0, 2.8041673028874933e-24, 5.888751335876745e-24, 9.281793771697075e-24, 1.301414045021179e-23, 1.7119721795075933e-23, 2.1635861272039378e-23, 2.6603614693052546e-23, 3.206814345074546e-23, 3.8079125076304345e-23, 4.46912048530683e-23, 5.1964492591394607e-23, 5.996510908088832e-23, 6.876578718769095e-23, 7.844653306127799e-23, 8.909535346164166e-23, 1.0080905581879734e-22, 1.136941282977127e-22, 1.2786770786902364e-22, 1.4345864518587742e-22, 1.606086759471988e-22, 1.7947370939559687e-22, 2.0022524566281201e-22, 2.2305193484670273e-22, 2.481612919919207e-22, 2.757815835633028e-22, 3.038232482189985e-22, 3.318649111771739e-22, 3.5990657228115646e-22, 3.8794823137427396e-22, 4.159898882998546e-22, 4.440315429012273e-22, 4.720731950217214e-22, 5.001148445046669e-22, 5.281564911933945e-22, 5.561981349312354e-22, 5.842397755615216e-22, 6.122814129275858e-22, 6.403230468727619e-22, 6.683646772403838e-22, 6.964063038737869e-22, 7.244479266163074e-22, 7.524895453112825e-22, 7.8053115980205e-22, 8.085727699319493e-22, 8.366143755443201e-22, 8.646559764825039e-22, 8.926975725898428e-22, 9.207391637096808e-22, 9.487807496853622e-22, 9.76822330360233e-22, 1.0048639055776405e-21, 1.0329054751809332e-21, 1.0609470390134612e-21, 1.0889885969185757e-21, 1.1170301487396295e-21, 1.1450716943199767e-21, 1.173113233502973e-21, 1.2011547661319758e-21, 1.229196292050344e-21, 1.2572378111014376e-21, 1.2852793231286192e-21, 1.3133208279752526e-21, 1.3413623254847032e-21, 1.3694038155003384e-21, 1.3974452978655274e-21, 1.425486772423641e-21, 1.453528239018052e-21, 1.4815696974921354e-21, 1.509611147689268e-21, 1.5376525894528283e-21, 1.5656940226261973e-21, 1.593735447052758e-21, 1.6217768625758953e-21, 1.6498182690389962e-21, 1.67785966628545e-21, 1.705901054158648e-21, 1.7339424325019848e-21, 1.7619838011588553e-21, 1.790025159972659e-21, 1.8180665087867968e-21, 1.846107847444671e-21, 1.874149175789688e-21, 1.9021904936652557e-21, 1.930231800914785e-21, 1.9582730973816887e-21, 1.9863143829093833e-21, 2.0143556573412872e-21, 2.0423969205208214e-21, 2.07043817229141e-21, 2.0984794124964797e-21, 2.1265206409794594e-21, 2.1545618575837825e-21, 2.182603062152883e-21, 2.2106442545301995e-21, 2.238685434559173e-21, 2.2667266020832478e-21, 2.2947677569458706e-21, 2.3228088989904914e-21, 2.350850028060563e-21], "losses": []}}};
        const THEORY_NAME = 'Kerr-Newman';
        const BLACK_HOLE_MASS = 99450000000000.0;
        
        // Particle colors
        const PARTICLE_COLORS = {
            electron: { 
                theory: [0.29, 0.62, 1.0, 1.0],  // Blue
                kerr: [0.29, 0.62, 1.0, 0.5]      // Blue (transparent)
            },
            neutrino: { 
                theory: [0.96, 0.26, 0.21, 1.0],  // Red
                kerr: [0.96, 0.26, 0.21, 0.5]     // Red (transparent)
            },
            photon: { 
                theory: [0.98, 0.74, 0.02, 1.0],  // Yellow
                kerr: [0.98, 0.74, 0.02, 0.5]     // Yellow (transparent)
            },
            proton: { 
                theory: [0.18, 0.80, 0.44, 1.0],  // Green
                kerr: [0.18, 0.80, 0.44, 0.5]     // Green (transparent)
            }
        };
        
        // Track which particles are enabled
        const particleEnabled = {};
        
        // WebGL setup
        const canvas = document.getElementById('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        
        if (!gl) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').innerHTML = 'WebGL not supported in your browser.';
            document.getElementById('error').style.display = 'block';
        }
        
        // Resize canvas
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            gl.viewport(0, 0, canvas.width, canvas.height);
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // Shader sources
        const vertexShaderSource = `
            attribute vec2 a_position;
            uniform mat3 u_matrix;
            uniform float u_pointSize;
            
            void main() {
                vec3 position = u_matrix * vec3(a_position, 1.0);
                gl_Position = vec4(position.xy, 0.0, 1.0);
                gl_PointSize = u_pointSize;
            }
        `;
        
        const fragmentShaderSource = `
            precision mediump float;
            uniform vec4 u_color;
            uniform float u_isPoint;
            
            void main() {
                if (u_isPoint > 0.5) {
                    // Draw circular point
                    vec2 coord = gl_PointCoord - vec2(0.5);
                    if (length(coord) > 0.5) {
                        discard;
                    }
                }
                gl_FragColor = u_color;
            }
        `;
        
        // Create shaders
        function createShader(gl, type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                console.error('Shader compilation error:', gl.getShaderInfoLog(shader));
                gl.deleteShader(shader);
                return null;
            }
            return shader;
        }
        
        const vertexShader = createShader(gl, gl.VERTEX_SHADER, vertexShaderSource);
        const fragmentShader = createShader(gl, gl.FRAGMENT_SHADER, fragmentShaderSource);
        
        // Create program
        const program = gl.createProgram();
        gl.attachShader(program, vertexShader);
        gl.attachShader(program, fragmentShader);
        gl.linkProgram(program);
        
        if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
            console.error('Program linking error:', gl.getProgramInfoLog(program));
        }
        
        // Get locations
        const positionLocation = gl.getAttribLocation(program, 'a_position');
        const matrixLocation = gl.getUniformLocation(program, 'u_matrix');
        const colorLocation = gl.getUniformLocation(program, 'u_color');
        const pointSizeLocation = gl.getUniformLocation(program, 'u_pointSize');
        const isPointLocation = gl.getUniformLocation(program, 'u_isPoint');
        
        // Create buffer
        const positionBuffer = gl.createBuffer();
        
        // Animation state
        let currentStep = 0;
        let isPlaying = true;
        let showTrail = true;
        let showGrid = true;
        let cameraX = 0;
        let cameraY = 0;
        let cameraZoom = 1;
        let animationSpeed = 3;
        
        // Calculate bounds from all particle data
        function calculateBounds() {
            let minX = Infinity, maxX = -Infinity;
            let minY = Infinity, maxY = -Infinity;
            
            if (PARTICLE_DATA) {
                Object.keys(PARTICLE_DATA).forEach(particleName => {
                    const particleData = PARTICLE_DATA[particleName];
                    ['theory', 'kerr'].forEach(dataType => {
                        const data = particleData[dataType];
                        if (data && data.positions) {
                            data.positions.forEach(pos => {
                                const x = pos[0] * Math.cos(pos[1]);
                                const y = pos[0] * Math.sin(pos[1]);
                                minX = Math.min(minX, x);
                                maxX = Math.max(maxX, x);
                                minY = Math.min(minY, y);
                                maxY = Math.max(maxY, y);
                            });
                        }
                    });
                });
            }
            
            const scale = Math.max(maxX - minX, maxY - minY) * 1.2;
            return { minX, maxX, minY, maxY, scale: scale || 100 };
        }
        
        // Matrix operations
        function createMatrix(tx, ty, scale) {
            const aspect = canvas.width / canvas.height;
            return [
                2 * scale / canvas.width, 0, 0,
                0, -2 * scale / canvas.height, 0,
                tx, ty, 1
            ];
        }
        
        // Draw scene
        function drawScene() {
            gl.clearColor(0.04, 0.04, 0.04, 1.0);
            gl.clear(gl.COLOR_BUFFER_BIT);
            
            gl.useProgram(program);
            
            const bounds = calculateBounds();
            const matrix = createMatrix(
                -cameraX / bounds.scale,
                -cameraY / bounds.scale,
                cameraZoom / bounds.scale
            );
            gl.uniformMatrix3fv(matrixLocation, false, matrix);
            
            // Draw grid
            if (showGrid) {
                drawGrid();
            }
            
            // Draw black hole
            drawBlackHole();
            
            // Draw all particle trajectories
            if (PARTICLE_DATA) {
                Object.keys(PARTICLE_DATA).forEach(particleName => {
                    if (particleEnabled[particleName]) {
                        const particleData = PARTICLE_DATA[particleName];
                        const colors = PARTICLE_COLORS[particleName];
                        
                        // Draw Kerr baseline (dashed)
                        if (particleData.kerr && particleData.kerr.positions) {
                            drawTrajectory(particleData.kerr, colors.kerr, currentStep, true);
                        }
                        
                        // Draw theory trajectory (solid)
                        if (particleData.theory && particleData.theory.positions) {
                            drawTrajectory(particleData.theory, colors.theory, currentStep, false);
                        }
                        
                        // Draw current positions
                        if (particleData.theory && particleData.theory.positions && 
                            currentStep < particleData.theory.positions.length) {
                            drawParticle(particleData.theory.positions[currentStep], colors.theory);
                        }
                        if (particleData.kerr && particleData.kerr.positions && 
                            currentStep < particleData.kerr.positions.length) {
                            drawParticle(particleData.kerr.positions[currentStep], colors.kerr);
                        }
                    }
                });
            }
        }
        
        function drawGrid() {
            const gridSize = 10;
            const gridLines = [];
            
            for (let i = -100; i <= 100; i += gridSize) {
                // Vertical lines
                gridLines.push(i, -100, i, 100);
                // Horizontal lines
                gridLines.push(-100, i, 100, i);
            }
            
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(gridLines), gl.STATIC_DRAW);
            gl.enableVertexAttribArray(positionLocation);
            gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
            
            gl.uniform4f(colorLocation, 0.2, 0.2, 0.2, 0.3);
            gl.uniform1f(isPointLocation, 0.0);
            
            for (let i = 0; i < gridLines.length / 4; i++) {
                gl.drawArrays(gl.LINES, i * 2, 2);
            }
        }
        
        function drawBlackHole() {
            const segments = 64;
            const vertices = [];
            
            // Event horizon (r = 2M)
            const r_horizon = 2;
            for (let i = 0; i <= segments; i++) {
                const angle = (i / segments) * Math.PI * 2;
                vertices.push(r_horizon * Math.cos(angle), r_horizon * Math.sin(angle));
            }
            
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
            gl.enableVertexAttribArray(positionLocation);
            gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
            
            gl.uniform4f(colorLocation, 1.0, 1.0, 1.0, 0.5);
            gl.uniform1f(isPointLocation, 0.0);
            gl.drawArrays(gl.LINE_LOOP, 0, vertices.length / 2);
        }
        
        function drawTrajectory(data, color, upToStep, isDashed) {
            if (!data.positions || data.positions.length === 0) return;
            
            const vertices = [];
            const limit = showTrail ? upToStep : Math.max(0, upToStep - 50);
            
            for (let i = Math.max(0, limit); i <= upToStep && i < data.positions.length; i++) {
                const pos = data.positions[i];
                const x = pos[0] * Math.cos(pos[1]);
                const y = pos[0] * Math.sin(pos[1]);
                vertices.push(x, y);
            }
            
            if (vertices.length > 2) {
                gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
                gl.enableVertexAttribArray(positionLocation);
                gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
                
                const alpha = showTrail ? color[3] : color[3] * 0.5;
                gl.uniform4f(colorLocation, color[0], color[1], color[2], alpha);
                gl.uniform1f(isPointLocation, 0.0);
                
                if (isDashed) {
                    // Draw dashed line for Kerr baseline
                    for (let i = 0; i < vertices.length / 2 - 1; i += 2) {
                        gl.drawArrays(gl.LINES, i, 2);
                    }
                } else {
                    gl.drawArrays(gl.LINE_STRIP, 0, vertices.length / 2);
                }
            }
        }
        
        function drawParticle(position, color) {
            const x = position[0] * Math.cos(position[1]);
            const y = position[0] * Math.sin(position[1]);
            
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([x, y]), gl.STATIC_DRAW);
            gl.enableVertexAttribArray(positionLocation);
            gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
            
            gl.uniform4f(colorLocation, color[0], color[1], color[2], color[3]);
            gl.uniform1f(pointSizeLocation, 8.0);
            gl.uniform1f(isPointLocation, 1.0);
            gl.drawArrays(gl.POINTS, 0, 1);
        }
        
        // Update info panel
        function updateInfo() {
            let maxSteps = 0;
            let currentTime = 0;
            
            if (PARTICLE_DATA) {
                Object.keys(PARTICLE_DATA).forEach(particleName => {
                    const particleData = PARTICLE_DATA[particleName];
                    if (particleData.theory && particleData.theory.positions) {
                        maxSteps = Math.max(maxSteps, particleData.theory.positions.length);
                        if (particleData.theory.times && currentStep < particleData.theory.times.length) {
                            currentTime = Math.max(currentTime, particleData.theory.times[currentStep]);
                        }
                    }
                });
            }
            
            document.getElementById('stepInfo').textContent = `${currentStep} / ${maxSteps}`;
            document.getElementById('timeInfo').textContent = currentTime.toExponential(2);
        }
        
        // Setup particle legend
        function setupParticleLegend() {
            const legend = document.getElementById('particleLegend');
            
            if (PARTICLE_DATA) {
                Object.keys(PARTICLE_DATA).forEach(particleName => {
                    const colors = PARTICLE_COLORS[particleName];
                    particleEnabled[particleName] = true; // Enable all by default
                    
                    const item = document.createElement('div');
                    item.className = 'particle-item';
                    item.innerHTML = `
                        <div class="color-box" style="background: rgb(${Math.round(colors.theory[0]*255)}, ${Math.round(colors.theory[1]*255)}, ${Math.round(colors.theory[2]*255)})"></div>
                        <div>${particleName}</div>
                    `;
                    
                    item.onclick = () => {
                        particleEnabled[particleName] = !particleEnabled[particleName];
                        item.classList.toggle('disabled', !particleEnabled[particleName]);
                    };
                    
                    legend.appendChild(item);
                });
            }
        }
        
        // Animation loop
        function animate() {
            if (isPlaying) {
                currentStep += animationSpeed;
                
                // Find max steps across all particles
                let maxSteps = 0;
                if (PARTICLE_DATA) {
                    Object.values(PARTICLE_DATA).forEach(particleData => {
                        if (particleData.theory && particleData.theory.positions) {
                            maxSteps = Math.max(maxSteps, particleData.theory.positions.length);
                        }
                    });
                }
                
                if (currentStep >= maxSteps - 1) {
                    currentStep = maxSteps - 1;
                    isPlaying = false;
                    document.getElementById('playPause').textContent = 'Play';
                }
            }
            
            drawScene();
            updateInfo();
            requestAnimationFrame(animate);
        }
        
        // Controls
        document.getElementById('playPause').addEventListener('click', () => {
            isPlaying = !isPlaying;
            document.getElementById('playPause').textContent = isPlaying ? 'Pause' : 'Play';
        });
        
        document.getElementById('reset').addEventListener('click', () => {
            currentStep = 0;
            isPlaying = false;
            document.getElementById('playPause').textContent = 'Play';
        });
        
        document.getElementById('speed').addEventListener('input', (e) => {
            animationSpeed = parseFloat(e.target.value);
        });
        
        document.getElementById('zoom').addEventListener('input', (e) => {
            cameraZoom = parseFloat(e.target.value);
        });
        
        document.getElementById('toggleTrail').addEventListener('click', (e) => {
            showTrail = !showTrail;
            e.target.classList.toggle('active', showTrail);
        });
        
        document.getElementById('toggleGrid').addEventListener('click', (e) => {
            showGrid = !showGrid;
            e.target.classList.toggle('active', showGrid);
        });
        
        // Mouse controls
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        
        canvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const dx = e.clientX - lastMouseX;
                const dy = e.clientY - lastMouseY;
                cameraX += dx * 2;
                cameraY += dy * 2;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
            }
        });
        
        canvas.addEventListener('mouseup', () => {
            isDragging = false;
        });
        
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const scaleFactor = e.deltaY > 0 ? 0.9 : 1.1;
            cameraZoom *= scaleFactor;
            cameraZoom = Math.max(0.1, Math.min(10, cameraZoom));
            document.getElementById('zoom').value = cameraZoom;
        });
        
        // Initialize
        document.getElementById('loading').style.display = 'none';
        document.getElementById('toggleTrail').classList.add('active');
        document.getElementById('toggleGrid').classList.add('active');
        setupParticleLegend();
        animate();
    </script>
</body>
</html>